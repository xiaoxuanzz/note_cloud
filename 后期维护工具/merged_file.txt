 
======================================================== 
ºÏ²¢Ê±¼ä: 2025/11/11 ÖÜ¶ş 22:23:01.35 
ºÏ²¢Ä¿Â¼: .. 
======================================================== 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\ajax.php ======= 
 
<?php
include('includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    echo json_encode(['error' => 'æœªæˆæƒ']);
    exit();
}

// è·å–AJAXè¯·æ±‚çš„ç±»å‹å’Œæ•°æ®
$action = $_POST['action'] ?? '';

switch ($action) {
    case 'save_note':
        $id = $_POST['id'];
        $title = $_POST['title'];
        $content = $_POST['content'];
        
        if ($id) {
            // æ›´æ–°ç¬”è®°
            $stmt = $pdo->prepare("UPDATE knowledge_notes SET title = ?, content = ? WHERE id = ? AND user_id = ?");
            $stmt->execute([$title, $content, $id, $_SESSION['user_id']]);
            echo json_encode(['status' => 'æ›´æ–°æˆåŠŸ']);
        } else {
            // åˆ›å»ºç¬”è®°
            $stmt = $pdo->prepare("INSERT INTO knowledge_notes (user_id, title, content) VALUES (?, ?, ?)");
            $stmt->execute([$_SESSION['user_id'], $title, $content]);
            echo json_encode(['status' => 'åˆ›å»ºæˆåŠŸ', 'id' => $pdo->lastInsertId()]);
        }
        break;
    case 'delete_note':
        $id = $_POST['id'];
        
        $stmt = $pdo->prepare("UPDATE knowledge_notes SET deleted_at = CURRENT_TIMESTAMP WHERE id = ? AND user_id = ?");
        $stmt->execute([$id, $_SESSION['user_id']]);
        
        echo json_encode(['status' => 'åˆ é™¤æˆåŠŸ']);
        break;
    case 'get_note':
        $id = $_POST['id'];
        
        $stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ? AND user_id = ?");
        $stmt->execute([$id, $_SESSION['user_id']]);
        $note = $stmt->fetch(PDO::FETCH_ASSOC);
        
        if (!$note) {
            echo json_encode(['error' => 'ç¬”è®°ä¸å­˜åœ¨']);
        } else {
            echo json_encode(['title' => $note['title'], 'content' => $note['content'], 'image_path' => $note['image_path'], 'file_path' => $note['file_path']]);
        }
        break;
    case 'upload_image':
        if (!empty($_FILES['image']['name'])) {
            $target_dir = 'uploads/images/';
            $target_file = $target_dir . basename($_FILES["image"]["name"]);
            $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));

            // å…è®¸çš„æ–‡ä»¶ç±»å‹
            $allowed_types = ['jpg', 'jpeg', 'png', 'gif'];

            if (in_array($imageFileType, $allowed_types)) {
                if (!is_dir($target_dir)) {
                    mkdir($target_dir, 0777, true);
                }
                if (move_uploaded_file($_FILES["image"]["tmp_name"], $target_file)) {
                    echo json_encode(['status' => 'ä¸Šä¼ æˆåŠŸ', 'image_path' => $target_file]);
                } else {
                    echo json_encode(['error' => 'å›¾ç‰‡ä¸Šä¼ å¤±è´¥']);
                }
            } else {
                echo json_encode(['error' => 'åªå…è®¸ JPG, JPEG, PNG, GIF æ ¼å¼']);
            }
        } else {
            echo json_encode(['error' => 'æœªä¸Šä¼ å›¾ç‰‡']);
        }
        break;
    case 'upload_file':
        if (!empty($_FILES['file']['name'])) {
            $target_dir = 'uploads/files/';
            $target_file = $target_dir . basename($_FILES["file"]["name"]);
            $file_type = pathinfo($target_file, PATHINFO_EXTENSION);

            if (!is_dir($target_dir)) {
                mkdir($target_dir, 0777, true);
            }
            if (move_uploaded_file($_FILES["file"]["tmp_name"], $target_file)) {
                echo json_encode(['status' => 'ä¸Šä¼ æˆåŠŸ', 'file_path' => $target_file]);
            } else {
                echo json_encode(['error' => 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥']);
            }
        } else {
            echo json_encode(['error' => 'æœªä¸Šä¼ æ–‡ä»¶']);
        }
        break;
    default:
        echo json_encode(['error' => 'æœªçŸ¥æ“ä½œ']);
} 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\ajax.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\api.php ======= 
 

<?php
include('includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("HTTP/1.1 401 Unauthorized");
    echo json_encode(['error' => 'æœªæˆæƒ']);
    exit();
}

// è·å–è¯·æ±‚æ–¹æ³•å’Œè·¯å¾„
$request_method = $_SERVER['REQUEST_METHOD'];
$path = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);

// è·¯ç”±å¤„ç†
switch ($path) {
    case '/api/notes':
        if ($request_method === 'GET') {
            // è·å–ç¬”è®°åˆ—è¡¨
            $stmt = $pdo->prepare("SELECT * FROM notes WHERE user_id = ? ORDER BY updated_at DESC");
            $stmt->execute([$_SESSION['user_id']]);
            $notes = $stmt->fetchAll(PDO::FETCH_ASSOC);
            echo json_encode($notes);
        } elseif ($request_method === 'POST') {
            // åˆ›å»ºç¬”è®°
            $data = json_decode(file_get_contents('php://input'), true);
            $title = $data['title'];
            $content = $data['content'];
            
            $stmt = $pdo->prepare("INSERT INTO notes (user_id, title, content) VALUES (?, ?, ?)");
            $stmt->execute([$_SESSION['user_id'], $title, $content]);
            
            echo json_encode(['id' => $pdo->lastInsertId()]);
        }
        break;
    case '/api/notes/' . end(explode('/', trim($path, '/'))):
        $id = end(explode('/', trim($path, '/')));
        if ($request_method === 'GET') {
            // è·å–å•ä¸ªç¬”è®°
            $stmt = $pdo->prepare("SELECT * FROM notes WHERE id = ? AND user_id = ?");
            $stmt->execute([$id, $_SESSION['user_id']]);
            $note = $stmt->fetch(PDO::FETCH_ASSOC);
            
            if (!$note) {
                header("HTTP/1.1 404 Not Found");
                echo json_encode(['error' => 'ç¬”è®°ä¸å­˜åœ¨']);
            } else {
                echo json_encode($note);
            }
        } elseif ($request_method === 'PUT') {
            // æ›´æ–°ç¬”è®°
            $data = json_decode(file_get_contents('php://input'), true);
            $title = $data['title'];
            $content = $data['content'];
            
            $stmt = $pdo->prepare("UPDATE notes SET title = ?, content = ? WHERE id = ? AND user_id = ?");
            $stmt->execute([$title, $content, $id, $_SESSION['user_id']]);
            
            echo json_encode(['status' => 'æ›´æ–°æˆåŠŸ']);
        } elseif ($request_method === 'DELETE') {
            // åˆ é™¤ç¬”è®°
            $stmt = $pdo->prepare("DELETE FROM notes WHERE id = ? AND user_id = ?");
            $stmt->execute([$id, $_SESSION['user_id']]);
            
            echo json_encode(['status' => 'åˆ é™¤æˆåŠŸ']);
        }
        break;
    default:
        header("HTTP/1.1 404 Not Found");
        echo json_encode(['error' => 'APIæœªæ‰¾åˆ°']);
} 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\api.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\favorites.php ======= 
 
<?php
session_start();
include('includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

// å¤„ç†æ”¶è—å’Œå–æ¶ˆæ”¶è—çš„è¯·æ±‚
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['note_id'])) {
    $noteId = $_POST['note_id'];
    if (isset($_POST['action']) && $_POST['action'] === 'add_favorite') {
        try {
            $stmt = $pdo->prepare("INSERT INTO favorites (user_id, note_id, created_at) VALUES (?, ?, NOW())");
            $stmt->execute([$_SESSION['user_id'], $noteId]);
        } catch (Exception $e) {
            error_log("Failed to add favorite: " . $e->getMessage());
        }
    } elseif (isset($_POST['action']) && $_POST['action'] === 'remove_favorite') {
        try {
            $stmt = $pdo->prepare("DELETE FROM favorites WHERE user_id = ? AND note_id = ?");
            $stmt->execute([$_SESSION['user_id'], $noteId]);
        } catch (Exception $e) {
            error_log("Failed to remove favorite: " . $e->getMessage());
        }
    }
    header("Location: favorites.php");
    exit();
}

// è·å–æ”¶è—å¤¹ä¸­çš„ç¬”è®°
$favoriteNotes = [];
try {
    $stmt = $pdo->prepare("SELECT kn.* FROM knowledge_notes kn 
                           INNER JOIN favorites f ON kn.id = f.note_id 
                           WHERE f.user_id = ? 
                           ORDER BY kn.created_at DESC");
    $stmt->execute([$_SESSION['user_id']]);
    $favoriteNotes = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch favorite notes: " . $e->getMessage());
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ”¶è—å¤¹</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-200px);
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 0;
        }
        .toggle-sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            display: none;
            background-color: #343a40;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-200px);
            }
            .main-content {
                margin-left: 0;
            }
            .toggle-sidebar {
                display: block;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content.active {
                margin-left: 200px;
            }
        }
        .note-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .note-card:hover {
            transform: translateY(-5px);
        }
        .note-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .note-card .card-body {
            padding: 20px;
        }
    </style>
</head>
<body>
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item active">
                        <a class="nav-link" href="knowledge/index.php">çŸ¥è¯†åº“</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="recycle.php">å›æ”¶ç«™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="favorites.php">æ”¶è—</a>
                    </li>
					<li class="nav-item">
					    <a class="nav-link" href="desp/index.html" target="_blank" rel="noopener noreferrer">AIæ™ºèƒ½ç¬”è®°</a>
					</li>
                    <?php if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']): ?>
                        <li class="nav-item">
                            <a class="nav-link" href="settings.php">è®¾ç½®</a>
                        </li>
                    <?php endif; ?>
                     <li class="nav-item">
                         <a class="nav-link" href="logout.php">é€€å‡ºç™»å½•</a>
                     </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
				<h2>æ”¶è—å¤¹</h2>
				<!-- æŒ‰é’®æ§ä»¶-->
				<button class="toggle-sidebar d-lg-none" onclick="toggleSidebar()" style="left: 85%;" id="an">â˜°</button>
				<br/>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="mb-0">æ”¶è—çš„ç¬”è®°</h3>
                            </div>
                            <div class="card-body">
                                <div class="row" id="notesContainer">
                                    <?php if (empty($favoriteNotes)): ?>
                                        <div class="col-md-12">
                                            <div class="card note-card">
                                                <div class="card-body text-center">
                                                    <p class="card-text">è¿˜æ²¡æœ‰æ”¶è—çš„ç¬”è®°å“¦</p>
                                                    <p class="card-text">æµè§ˆçŸ¥è¯†åº“å¹¶æ”¶è—æ‚¨å–œæ¬¢çš„ç¬”è®°~</p>
                                                </div>
                                            </div>
                                        </div>
                                    <?php else: ?>
                                        <?php foreach ($favoriteNotes as $note): ?>
                                            <div class="col-md-12 mb-4">
                                                <div class="card note-card">
                                                    <div class="card-header d-flex justify-content-between align-items-center">
                                                        <span><?php echo htmlspecialchars($note['title']); ?></span>
                                                        <small class="text-muted"><?php echo $note['created_at']; ?></small>
                                                    </div>
                                                    <div class="card-body">
                                                        <p class="card-text"><?php echo htmlspecialchars($note['content']); ?></p>
                                                        <?php
                                                        $hasImages = !empty($note['images']) && json_decode($note['images'], true);
                                                        $hasFiles = !empty($note['files']) && json_decode($note['files'], true);
                                                        if ($hasImages || $hasFiles): ?>
                                                            <p class="text-muted">ï¼ˆå«å›¾ç‰‡æˆ–æ–‡ä»¶ï¼‰</p>
                                                        <?php endif; ?>
                                                        <div class="d-flex justify-content-between mt-2">
                                                            <div>
                                                                <a href="knowledge/favories_view.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-secondary">æµè§ˆ</a>
                                                                <form method="POST" action="favorites.php" style="display: inline;">
                                                                    <input type="hidden" name="note_id" value="<?php echo $note['id']; ?>">
                                                                    <input type="hidden" name="action" value="remove_favorite">
                                                                    <button type="submit" class="btn btn-sm btn-outline-danger">å–æ¶ˆæ”¶è—</button>
                                                                </form>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleButton = document.querySelector('.toggle-sidebar');

                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target) && window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const swipeThreshold = 50;
                const difference = Math.abs(touchEndX - touchStartX);

                if (difference > swipeThreshold && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            }
        }
    </script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\favorites.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\index.php ======= 
 
<?php
/**
 * PZIOTç¬”è®°ç½‘ - å…¥å£æ–‡ä»¶
 * åŠŸèƒ½ï¼šå®‰è£…æ£€æµ‹ â†’ ç™»å½•éªŒè¯ â†’ è‡ªåŠ¨è·³è½¬
 * 
 * ä¿®å¤è¯´æ˜ï¼š
 * 1. INSTALL_LOCK è·¯å¾„ä¿®å¤ï¼šBASE_PATH . '/install.lock'ï¼ˆå¿…é¡»å¸¦æ–œæ ï¼‰
 * 2. æ‰€æœ‰ header Location æ”¹ä¸ºç»å¯¹è·¯å¾„ï¼ˆå¸¦ /ï¼‰é¿å…è·¯å¾„æ··æ·†
 */

// ==================== 1. å®‰è£…æ£€æµ‹ ====================
define('BASE_PATH', __DIR__);
define('INSTALL_LOCK', BASE_PATH . '/install/install.lock');  // âœ… ä¿®å¤ï¼šæ·»åŠ æ–œæ 

// æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
if (!file_exists(INSTALL_LOCK)) {
    // æœªå®‰è£… -> è·³è½¬åˆ°å®‰è£…é¡µé¢
    header('Location: /install/install.php');  // âœ… ä½¿ç”¨ç»å¯¹è·¯å¾„
    exit();
}

// ==================== 2. ä¼šè¯åˆå§‹åŒ– ====================
session_start();

// ==================== 3. ç™»å½•çŠ¶æ€éªŒè¯ ====================
// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    // æœªç™»å½• -> è·³è½¬åˆ°ç™»å½•é¡µ
    header('Location: /login.php');  // âœ… ä½¿ç”¨ç»å¯¹è·¯å¾„
    exit();
}

// ==================== 4. å·²ç™»å½• -> è·³è½¬åˆ°çŸ¥è¯†åº“é¦–é¡µ ====================
// 301æ°¸ä¹…é‡å®šå‘ï¼Œé¿å…SEOé—®é¢˜
header('HTTP/1.1 301 Moved Permanently');
header('Location: /knowledge/index.php');  // âœ… ä½¿ç”¨ç»å¯¹è·¯å¾„
exit(); 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\index.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\login.php ======= 
 
<?php
session_start();
include('includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
if (isset($_SESSION['user_id'])) {
    header("Location: knowledge/index.php");
    exit();
}

// å¤„ç†ç”¨æˆ·ç™»å½•
$login_error = '';
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $username = $_POST['username'];
    $password = $_POST['password'];
    
    // ä½¿ç”¨ $pdo æŸ¥è¯¢æ•°æ®åº“
    $stmt = $pdo->prepare("SELECT * FROM users WHERE username = ?");
    $stmt->execute([$username]);
    $user = $stmt->fetch();
    
    if ($user && $password === $user['password']) {
        // æ£€æŸ¥æ˜¯å¦é€šè¿‡å®¡æ‰¹
        if ($user['approved'] == 1) {
            // ç™»å½•æˆåŠŸï¼Œè®¾ç½®ä¼šè¯å˜é‡
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['username'] = $user['username'];
            $_SESSION['role'] = $user['role'];
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç‰¹å®šç”¨æˆ· xiaoxuan
            if ($user['username'] === 'xiaoxuan') {
                $_SESSION['is_xiaoxuan'] = true;
            }
            
            header("Location: knowledge/index.php");
            exit();
        } else {
            $login_error = "æ‚¨çš„è´¦å·å°šæœªé€šè¿‡å®¡æ‰¹ï¼Œè¯·ç­‰å¾…ç®¡ç†å‘˜å®¡æ ¸";
        }
    } else {
        $login_error = "ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯";
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘ - ç™»å½•</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6 col-sm-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">ç™»å½•åˆ°PZIOTç¬”è®°ç½‘</h3>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            <div class="mb-3">
                                <label for="username" class="form-label">ç”¨æˆ·å</label>
                                <input type="text" class="form-control" id="username" name="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">å¯†ç </label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>
                            <button type="submit" name="login" class="btn btn-primary w-100">ç™»å½•</button>
                            <?php if (!empty($login_error)): ?>
                                <div class="alert alert-danger mt-3"><?php echo $login_error; ?></div>
                            <?php endif; ?>
                        </form>
                        <a href="register.php" class="btn btn-link text-center mt-3">æ²¡æœ‰è´¦å·ï¼Ÿç«‹å³æ³¨å†Œ</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\login.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\logout.php ======= 
 
<?php
session_start();

// é”€æ¯ä¼šè¯
$_SESSION = [];
session_unset();
session_destroy();

// é‡å®šå‘åˆ°ç™»å½•é¡µé¢
header("Location: login.php");
exit(); 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\logout.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\recycle.php ======= 
 
<?php
session_start();
include('includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

// è·å–å›æ”¶ç«™ä¸­çš„ç¬”è®°
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE user_id = ? AND deleted_at IS NOT NULL ORDER BY deleted_at DESC");
$stmt->execute([$_SESSION['user_id']]);
$recycleNotes = $stmt->fetchAll(PDO::FETCH_ASSOC);

// å¤„ç†æ¢å¤ç¬”è®°
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['restore'])) {
    $noteId = $_POST['note_id'];
    $stmt = $pdo->prepare("UPDATE knowledge_notes SET deleted_at = NULL WHERE id = ? AND user_id = ?");
    $stmt->execute([$noteId, $_SESSION['user_id']]);
    header("Location: recycle.php");
    exit();
}

// å¤„ç†å½»åº•åˆ é™¤ç¬”è®°
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['delete-permanent'])) {
    $noteId = $_POST['note_id'];
    $stmt = $pdo->prepare("DELETE FROM knowledge_notes WHERE id = ? AND user_id = ?");
    $stmt->execute([$noteId, $_SESSION['user_id']]);
    header("Location: recycle.php");
    exit();
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-200px);
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 0;
        }
        .toggle-sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            display: none;
            background-color: #343a40;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-200px);
            }
            .main-content {
                margin-left: 0;
            }
            .toggle-sidebar {
                display: block;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content.active {
                margin-left: 200px;
            }
        }
    </style>
</head>
<body>

    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="knowledge/index.php">çŸ¥è¯†åº“</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="recycle.php">å›æ”¶ç«™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="favorites.php">æ”¶è—</a>
                    </li>
					<li class="nav-item">
					    <a class="nav-link" href="desp/index.html" target="_blank" rel="noopener noreferrer">AIæ™ºèƒ½ç¬”è®°</a>
					</li>
                    <?php if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']): ?>
                        <li class="nav-item">
                            <a class="nav-link" href="settings.php">è®¾ç½®</a>
                        </li>
                    <?php endif; ?>
                    <li class="nav-item">
                        <a class="nav-link" href="../logout.php">é€€å‡ºç™»å½•</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>å›æ”¶ç«™</h2>
				<button class="toggle-sidebar d-lg-none" onclick="toggleSidebar()" style="left: 85%;" id="an">â˜°</button>
				<br/>
                <div class="row mt-4">
                    <?php foreach ($recycleNotes as $note): ?>
                        <div class="col-md-12">
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span><?php echo htmlspecialchars($note['title']); ?></span>
                                    <small class="text-muted">åˆ é™¤æ—¶é—´: <?php echo $note['deleted_at']; ?></small>
                                </div>
                                <div class="card-body">
                                    <p class="card-text"><?php echo htmlspecialchars($note['content']); ?></p>
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <a href="knowledge/recycle_view.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-secondary">æŸ¥çœ‹</a>
                                        </div>
                                        <div>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="note_id" value="<?php echo $note['id']; ?>">
                                                <button type="submit" name="restore" class="btn btn-sm btn-outline-primary">æ¢å¤</button>
                                            </form>
                                            <form method="POST" style="display: inline;">
                                                <input type="hidden" name="note_id" value="<?php echo $note['id']; ?>">
                                                <button type="submit" name="delete-permanent" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šæ°¸ä¹…åˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')">æ°¸ä¹…åˆ é™¤</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleButton = document.querySelector('.toggle-sidebar');
                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target) && window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const swipeThreshold = 50;
                const difference = Math.abs(touchEndX - touchStartX);

                if (difference > swipeThreshold && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            }
        }

        // æŒ‰é’®çš„JS
        function isMobile() {
            return /Mobi|Android|iPhone/i.test(navigator.userAgent);
        }
        if (isMobile()) {
            document.querySelector('.toggle-sidebar').style.display = 'block';
        } else {
            document.querySelector('.toggle-sidebar').style.display = 'none';
        }
    </script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\recycle.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\register.php ======= 
 
<?php
session_start();

// æ£€æŸ¥é…ç½®æ–‡ä»¶
if (!file_exists('includes/config.php')) {
    die('<div style="text-align:center; padding:50px;">
            <h2>âš ï¸ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨</h2>
            <p>è¯·å…ˆè¿è¡Œ <a href="install/install.php">å®‰è£…ç¨‹åº</a></p>
        </div>');
}

include('includes/config.php');

// âœ… åˆ›å»º PDO æ•°æ®åº“è¿æ¥
try {
    $pdo = new PDO(
        "mysql:host={$dbconfig['host']};port={$dbconfig['port']};dbname={$dbconfig['dbname']};charset=utf8mb4",
        $dbconfig['user'],
        $dbconfig['pwd'],
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false
        ]
    );
} catch (PDOException $e) {
    die('<div style="text-align:center; padding:50px; color:red;">
            <h2>æ•°æ®åº“è¿æ¥å¤±è´¥</h2>
            <p>é”™è¯¯ä¿¡æ¯ï¼š' . htmlspecialchars($e->getMessage()) . '</p>
            <p>è¯·æ£€æŸ¥ includes/config.php é…ç½®æ˜¯å¦æ­£ç¡®</p>
        </div>');
}

// æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
if (isset($_SESSION['user_id'])) {
    header("Location: knowledge/index.php");
    exit();
}

// å¤„ç†æ³¨å†Œ
$register_error = '';
$register_success = '';

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $username = trim($_POST['username']);
    $email = trim($_POST['email']);
    $password = $_POST['password'];
    $password_confirm = $_POST['password_confirm'];
    
    // éªŒè¯è¾“å…¥
    if (empty($username) || empty($email) || empty($password)) {
        $register_error = "æ‰€æœ‰å­—æ®µéƒ½å¿…é¡»å¡«å†™";
    } elseif (strlen($username) < 3 || strlen($username) > 20) {
        $register_error = "ç”¨æˆ·åé•¿åº¦å¿…é¡»åœ¨3-20ä½ä¹‹é—´";
    } elseif (!filter_var($email, FILTER_VALIDATE_EMAIL)) {
        $register_error = "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®";
    } elseif (strlen($password) < 6) {
        $register_error = "å¯†ç é•¿åº¦è‡³å°‘6ä½";
    } elseif ($password !== $password_confirm) {
        $register_error = "ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´";
    } else {
        try {
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            $stmt = $pdo->prepare("SELECT id FROM users WHERE username = ?");
            $stmt->execute([$username]);
            if ($stmt->fetch()) {
                $register_error = "ç”¨æˆ·åå·²å­˜åœ¨";
            } else {
                // æ£€æŸ¥é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
                $stmt = $pdo->prepare("SELECT id FROM users WHERE email = ?");
                $stmt->execute([$email]);
                if ($stmt->fetch()) {
                    $register_error = "é‚®ç®±å·²è¢«æ³¨å†Œ";
                } else {
                    // âœ… æ’å…¥æ–°ç”¨æˆ·ï¼ˆapproved é»˜è®¤ä¸º 0ï¼Œéœ€è¦å®¡æ‰¹ï¼‰
                    $passwordHash = password_hash($password, PASSWORD_BCRYPT, ['cost' => 12]);
                    $stmt = $pdo->prepare("INSERT INTO users (username, password_hash, email, role, status, approved, created_at) VALUES (?, ?, ?, 'user', 1, 0, NOW())");
                    $stmt->execute([$username, $passwordHash, $email]);
                    
                    $register_success = "æ³¨å†ŒæˆåŠŸï¼æ‚¨çš„è´¦å·éœ€è¦ç®¡ç†å‘˜å®¡æ‰¹ï¼Œè¯·è€å¿ƒç­‰å¾…";
                }
            }
        } catch (PDOException $e) {
            $register_error = "ç³»ç»Ÿé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•";
            error_log("Register error: " . $e->getMessage());
        }
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘ - æ³¨å†Œ</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .register-container {
            max-width: 500px;
            margin: 0 auto;
        }
        .card {
            border: none;
            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
            border-radius: 15px;
            overflow: hidden;
        }
        .card-header {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            text-align: center;
            padding: 20px;
            border: none;
        }
        .card-header h3 {
            margin: 0;
            font-weight: bold;
        }
        .card-body {
            padding: 30px;
        }
        .alert {
            border-radius: 8px;
            border: none;
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            padding: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }
        .form-control:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
    </style>
</head>
<body>
    <div class="register-container">
        <div class="card">
            <div class="card-header">
                <h3>ğŸ“ è´¦å·æ³¨å†Œ</h3>
            </div>
            <div class="card-body">
                <?php if (!empty($register_error)): ?>
                    <div class="alert alert-danger"><?= htmlspecialchars($register_error) ?></div>
                <?php endif; ?>
                
                <?php if (!empty($register_success)): ?>
                    <div class="alert alert-success"><?= htmlspecialchars($register_success) ?></div>
                    <div class="text-center">
                        <a href="login.php" class="btn btn-success">å‰å¾€ç™»å½•</a>
                    </div>
                <?php else: ?>
                    <form method="POST">
                        <div class="mb-3">
                            <label for="username" class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="username" name="username" required autofocus
                                   value="<?= isset($_POST['username']) ? htmlspecialchars($_POST['username']) : '' ?>">
                            <small class="text-muted">3-20ä½å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿</small>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">é‚®ç®±</label>
                            <input type="email" class="form-control" id="email" name="email" required
                                   value="<?= isset($_POST['email']) ? htmlspecialchars($_POST['email']) : '' ?>">
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="password" name="password" required minlength="6">
                            <small class="text-muted">è‡³å°‘6ä½å­—ç¬¦</small>
                        </div>
                        <div class="mb-3">
                            <label for="password_confirm" class="form-label">ç¡®è®¤å¯†ç </label>
                            <input type="password" class="form-control" id="password_confirm" name="password_confirm" required minlength="6">
                        </div>
                        <button type="submit" class="btn btn-success w-100">æ³¨å†Œè´¦å·</button>
                    </form>
                    
                    <div class="text-center mt-4">
                        <a href="login.php" class="btn btn-link">å·²æœ‰è´¦å·ï¼Ÿç«‹å³ç™»å½•</a>
                    </div>
                <?php endif; ?>
            </div>
        </div>
    </div>

    <script src="js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\register.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\settings.php ======= 
 
<?php
session_start();
include('includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ä¸”æ˜¯ xiaoxuan ç”¨æˆ·
if (!isset($_SESSION['user_id']) || !isset($_SESSION['is_xiaoxuan']) || !$_SESSION['is_xiaoxuan']) {
    header("Location: index.php");
    exit();
}

// è·å–æœªå®¡æ‰¹ç”¨æˆ·
$unapprovedUsers = [];
try {
    $stmt = $pdo->query("SELECT * FROM users WHERE approved = 0 ORDER BY created_at");
    $unapprovedUsers = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    error_log("Failed to fetch unapproved users: " . $e->getMessage());
}

// å¤„ç†ç”¨æˆ·å®¡æ‰¹
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['approve_user'])) {
    $userId = $_POST['user_id'];
    try {
        $stmt = $pdo->prepare("UPDATE users SET approved = 1 WHERE id = ?");
        $stmt->execute([$userId]);
        header("Location: settings.php");
        exit();
    } catch (Exception $e) {
        error_log("Failed to approve user: " . $e->getMessage());
    }
}

// è·å–æ‰€æœ‰ç”¨æˆ·
$users = [];
try {
    $stmt = $pdo->query("SELECT * FROM users ORDER BY created_at");
    $users = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    error_log("Failed to fetch users: " . $e->getMessage());
}

// è·å–æ‰€æœ‰ç¬”è®°
$notes = [];
try {
    $stmt = $pdo->query("SELECT * FROM knowledge_notes ORDER BY created_at");
    $notes = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (Exception $e) {
    error_log("Failed to fetch notes: " . $e->getMessage());
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘</title>
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-200px);
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 0;
        }
        .toggle-sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            display: none;
            background-color: #343a40;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-200px);
            }
            .main-content {
                margin-left: 0;
            }
         .toggle-sidebar {
             display: block;
         }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content.active {
                margin-left: 200px;
            }
            .section-header {
                font-size: 1.5rem;
                margin-top: 20px;
                margin-bottom: 15px;
                border-bottom: 1px solid #dee2e6;
                padding-bottom: 5px;
            }
            .table-container {
                overflow-x: auto;
                margin-bottom: 15px;
            }
            table {
                min-width: 600px;
            }
            .form-group {
                margin-bottom: 15px;
            }
            .form-group label {
                display: block;
                margin-bottom: 5px;
            }
            .form-group select,
            .form-group input {
                width: 100%;
                padding: 8px;
                box-sizing: border-box;
            }
            .btn-group {
                margin-top: 10px;
            }
            .btn {
                padding: 8px 12px;
                margin-right: 5px;
                margin-bottom: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="knowledge/index.php">çŸ¥è¯†åº“</a>
                    </li>
                    <li class="nav-item active">
                        <a class="nav-link" href="recycle.php">å›æ”¶ç«™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="favorites.php">æ”¶è—</a>
                    </li>
					<li class="nav-item">
					    <a class="nav-link" href="desp/index.html" target="_blank" rel="noopener noreferrer">AIæ™ºèƒ½ç¬”è®°</a>
					</li>
                    <?php if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']): ?>
                        <li class="nav-item">
                            <a class="nav-link" href="settings.php">è®¾ç½®</a>
                        </li>
                    <?php endif; ?>
                    <li class="nav-item">
                        <a class="nav-link" href="../logout.php">é€€å‡ºç™»å½•</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>ç³»ç»Ÿè®¾ç½®</h2>
				<button class="toggle-sidebar d-lg-none" onclick="toggleSidebar()" style="left: 85%;" id="an">â˜°</button>
				<br/>
                <!-- ç”¨æˆ·å®¡æ‰¹åŒºåŸŸ -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h3 class="section-header">ç”¨æˆ·å®¡æ‰¹</h3>
                        <div class="table-container">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>é‚®ç®±</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($unapprovedUsers as $user): ?>
                                        <tr>
                                            <td><?php echo $user['id']; ?></td>
                                            <td><?php echo htmlspecialchars($user['username']); ?></td>
                                            <td><?php echo htmlspecialchars($user['email']); ?></td>
                                            <td><?php echo $user['created_at']; ?></td>
                                            <td>
                                                <form method="POST" style="display: inline;">
                                                    <input type="hidden" name="user_id" value="<?php echo $user['id']; ?>">
                                                    <input type="hidden" name="approve_user" value="1">
                                                    <button type="submit" class="btn btn-sm btn-primary">å®¡æ‰¹</button>
                                                </form>
                                                <form method="POST" action="admin/delete_user.php?id=<?php echo $user['id']; ?>" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šæ‹’ç»æ­¤ç”¨æˆ·å—ï¼Ÿ')">æ‹’ç»</button>
                                                </form>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç”¨æˆ·ç®¡ç†åŒºåŸŸ -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h3 class="section-header">ç”¨æˆ·ç®¡ç†</h3>
                        <div class="table-container">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>ç”¨æˆ·å</th>
                                        <th>é‚®ç®±</th>
                                        <th>è§’è‰²</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($users as $user): ?>
                                        <tr>
                                            <td><?php echo $user['id']; ?></td>
                                            <td><?php echo htmlspecialchars($user['username']); ?></td>
                                            <td><?php echo htmlspecialchars($user['email']); ?></td>
                                            <td><?php echo $user['role']; ?></td>
                                            <td><?php echo $user['created_at']; ?></td>
                                            <td>
                                                <a href="admin/edit_user.php?id=<?php echo $user['id']; ?>" class="btn btn-sm btn-primary">ç¼–è¾‘</a>
                                                <?php if ($user['username'] !== 'xiaoxuan'): ?>
                                                    <a href="admin/delete_user.php?id=<?php echo $user['id']; ?>" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿ')">åˆ é™¤</a>
                                                <?php endif; ?>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ç¬”è®°ç®¡ç†åŒºåŸŸ -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h3 class="section-header">ç¬”è®°ç®¡ç†</h3>
                        <div class="table-container">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>æ ‡é¢˜</th>
                                        <th>å†…å®¹</th>
                                        <th>å›¾ç‰‡è·¯å¾„</th>
                                        <th>æ–‡ä»¶è·¯å¾„</th>
                                        <th>åˆ›å»ºæ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($notes as $note): ?>
                                        <tr>
                                            <td><?php echo $note['id']; ?></td>
                                            <td><?php echo htmlspecialchars($note['title']); ?></td>
                                            <td><?php echo htmlspecialchars($note['content']); ?></td>
                                            <td><?php echo $note['image_path']; ?></td>
                                            <td><?php echo $note['file_path']; ?></td>
                                            <td><?php echo $note['created_at']; ?></td>
                                            <td>
                                                <a href="admin/edit_note.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                                                <form method="POST" action="admin/delete_note.php?id=<?php echo $note['id']; ?>" style="display: inline;">
                                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')">åˆ é™¤</button>
                                                </form>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
	
    <script src="js/bootstrap.bundle.min.js"></script>
    <script>
       function isMobile() {
         return /Mobi|Android|iPhone/i.test(navigator.userAgent);
       }
       isMobile()
       if(isMobile()==true){
       	document.querySelector('#an').style.display = 'block'
       }else{
       	document.querySelector('#an').style.display = 'none'
       }
       //è¿™é‡Œç»“æŸ
       function toggleSidebar() {
           const sidebar = document.querySelector('.sidebar');
           const mainContent = document.querySelector('.main-content');
           sidebar.classList.toggle('active');
           mainContent.classList.toggle('active');
       }
	   

        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ”¶èµ·ä¾§è¾¹æ 
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleButton = document.querySelector('.toggle-sidebar');

                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target) && window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        // ç‚¹å‡»ä¾§è¾¹æ ä¸­çš„é“¾æ¥æ—¶æ”¶èµ·ä¾§è¾¹æ 
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\settings.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\view.php ======= 
 
<?php
session_start();
include('includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: login.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ?");
$stmt->execute([$id]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨");
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹ç¬”è®° - PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1>æŸ¥çœ‹ç¬”è®°</h1>
                <a href="knowledge/index.php" class="btn btn-secondary">è¿”å›çŸ¥è¯†åº“</a>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><?php echo htmlspecialchars($note['title']); ?></h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><?php echo htmlspecialchars($note['content']); ?></p>
                        <?php if (!empty($note['images'])): ?>
                            <?php foreach (json_decode($note['images'], true) as $image): ?>
                                <img src="<?php echo $image; ?>" alt="ç¬”è®°å›¾ç‰‡" class="img-fluid rounded mb-2" style="max-height: 500px;">
                            <?php endforeach; ?>
                        <?php endif; ?>
                        <?php if (!empty($note['files'])): ?>
                            <div class="mt-2">
                                <?php foreach (json_decode($note['files'], true) as $file): ?>
                                    <a href="knowledge/uploads/files/<?php echo basename($file); ?>" class="btn btn-sm btn-outline-primary" download>ä¸‹è½½æ–‡ä»¶</a>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">åˆ›å»ºè€…: 
                                <?php
                                $userStmt = $pdo->prepare("SELECT username FROM users WHERE id = ?");
                                $userStmt->execute([$note['user_id']]);
                                $user = $userStmt->fetch();
                                echo htmlspecialchars($user['username']);
                                ?>
                            </small>
                            <div>
                                <?php if (isset($_SESSION['user_id']) && $_SESSION['user_id'] == $note['user_id']): ?>
                                    <a href="knowledge/delete.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')">åˆ é™¤</a>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\view.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\admin\dashboard.php ======= 
 
<?php
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ä¸”ä¸ºç®¡ç†å‘˜
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
    header("Location: ../login.php");
    exit();
}

// è·å–ç”¨æˆ·ç»Ÿè®¡
$stmt = $pdo->query("SELECT COUNT(*) FROM users");
$user_count = $stmt->fetchColumn();

// è·å–ç¬”è®°ç»Ÿè®¡
$stmt = $pdo->query("SELECT COUNT(*) FROM notes");
$note_count = $stmt->fetchColumn();
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†é¢æ¿ - å±€åŸŸç½‘ç¬”è®°åä½œç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1>ç®¡ç†é¢æ¿</h1>
                <a href="users.php" class="btn btn-primary mt-3">ç”¨æˆ·ç®¡ç†</a>
                <a href="settings.php" class="btn btn-secondary mt-3">ç³»ç»Ÿè®¾ç½®</a>
                <a href="../../logout.php" class="btn btn-danger mt-3">é€€å‡ºç™»å½•</a>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2 class="card-title"><?php echo $user_count; ?></h2>
                        <p class="card-text">æ€»ç”¨æˆ·æ•°</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2 class="card-title"><?php echo $note_count; ?></h2>
                        <p class="card-text">æ€»ç¬”è®°æ•°</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2 class="card-title">0</h2>
                        <p class="card-text">ç­‰å¾…å®¡æ ¸</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center">
                    <div class="card-body">
                        <h2 class="card-title">0</h2>
                        <p class="card-text">ä»Šæ—¥æ–°å¢</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\admin\dashboard.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\admin\delete_note.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ä¸”æ˜¯ xiaoxuan ç”¨æˆ·
if (!isset($_SESSION['user_id']) || !isset($_SESSION['is_xiaoxuan']) || !$_SESSION['is_xiaoxuan']) {
    header("Location: ../index.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ?");
$stmt->execute([$id]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨");
}

// åˆ é™¤ç¬”è®°
try {
    $stmt = $pdo->prepare("DELETE FROM knowledge_notes WHERE id = ?");
    $stmt->execute([$id]);
    header("Location: ../settings.php");
    exit();
} catch (Exception $e) {
    error_log("Failed to delete note: " . $e->getMessage());
    die("åˆ é™¤ç¬”è®°å¤±è´¥");
} 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\admin\delete_note.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\admin\delete_user.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ä¸”æ˜¯ xiaoxuan ç”¨æˆ·
if (!isset($_SESSION['user_id']) || !isset($_SESSION['is_xiaoxuan']) || !$_SESSION['is_xiaoxuan']) {
    header("Location: ../index.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
$stmt->execute([$id]);
$user = $stmt->fetch();

if (!$user) {
    die("ç”¨æˆ·ä¸å­˜åœ¨");
}

// åˆ é™¤ç”¨æˆ·
try {
    $stmt = $pdo->prepare("DELETE FROM users WHERE id = ?");
    $stmt->execute([$id]);
    header("Location: ../settings.php");
    exit();
} catch (Exception $e) {
    error_log("Failed to delete user: " . $e->getMessage());
    die("åˆ é™¤ç”¨æˆ·å¤±è´¥");
} 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\admin\delete_user.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\admin\edit_note.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ä¸”æ˜¯ xiaoxuan ç”¨æˆ·
if (!isset($_SESSION['user_id']) || !isset($_SESSION['is_xiaoxuan']) || !$_SESSION['is_xiaoxuan']) {
    header("Location: ../index.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ?");
$stmt->execute([$id]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨");
}

// å¤„ç†ç¬”è®°æ›´æ–°
$update_error = '';
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $title = $_POST['title'];
    $content = $_POST['content'];
    
    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    $image_path = $note['image_path'];
    if (!empty($_FILES['image']['name'])) {
        $target_dir = '../uploads/images/';
        $target_file = $target_dir . basename($_FILES["image"]["name"]);
        $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));

        // å…è®¸çš„æ–‡ä»¶ç±»å‹
        $allowed_types = ['jpg', 'jpeg', 'png', 'gif'];

        if (in_array($imageFileType, $allowed_types)) {
            if (!is_dir($target_dir)) {
                mkdir($target_dir, 0777, true);
            }
            if (move_uploaded_file($_FILES["image"]["tmp_name"], $target_file)) {
                $image_path = $target_file;
            } else {
                $update_error = "å›¾ç‰‡ä¸Šä¼ å¤±è´¥";
            }
        } else {
            $update_error = "åªå…è®¸ JPG, JPEG, PNG, GIF æ ¼å¼";
        }
    }

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    $file_path = $note['file_path'];
    if (!empty($_FILES['file']['name'])) {
        $target_dir = '../uploads/files/';
        $target_file = $target_dir . basename($_FILES["file"]["name"]);
        $file_type = pathinfo($target_file, PATHINFO_EXTENSION);

        if (!is_dir($target_dir)) {
            mkdir($target_dir, 0777, true);
        }
        if (move_uploaded_file($_FILES["file"]["tmp_name"], $target_file)) {
            $file_path = $target_file;
        } else {
            $update_error = "æ–‡ä»¶ä¸Šä¼ å¤±è´¥";
        }
    }

    if (empty($title)) {
        $update_error = 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º';
    } else {
        try {
            $stmt = $pdo->prepare("UPDATE knowledge_notes SET title = ?, content = ?, image_path = ?, file_path = ? WHERE id = ?");
            $stmt->execute([$title, $content, $image_path, $file_path, $id]);
            header("Location: ../settings.php");
            exit();
        } catch (Exception $e) {
            $update_error = 'æ›´æ–°ç¬”è®°æ—¶å‡ºé”™: ' . $e->getMessage();
        }
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘ç¬”è®° - PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">ç¼–è¾‘ç¬”è®°</h3>
                    </div>
                    <div class="card-body">
                        <form method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="title" class="form-label">æ ‡é¢˜</label>
                                <input type="text" class="form-control" id="title" name="title" value="<?php echo htmlspecialchars($note['title']); ?>" required>
                            </div>
                            <div class="mb-3">
                                <label for="content" class="form-label">å†…å®¹</label>
                                <textarea class="form-control" id="content" name="content" rows="5" required><?php echo htmlspecialchars($note['content']); ?></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="image" class="form-label">ä¸Šä¼ å›¾ç‰‡</label>
                                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                <?php if (!empty($note['image_path'])): ?>
                                    <div class="mt-2">
                                        <img src="<?php echo $note['image_path']; ?>" alt="å½“å‰å›¾ç‰‡" class="img-fluid rounded" style="max-height: 200px;">
                                    </div>
                                <?php endif; ?>
                            </div>
                            <div class="mb-3">
                                <label for="file" class="form-label">ä¸Šä¼ æ–‡ä»¶</label>
                                <input type="file" class="form-control" id="file" name="file">
                                <?php if (!empty($note['file_path'])): ?>
                                    <div class="mt-2">
                                        <a href="<?php echo $note['file_path']; ?>" class="btn btn-sm btn-outline-primary" download>ä¸‹è½½å½“å‰æ–‡ä»¶</a>
                                    </div>
                                <?php endif; ?>
                            </div>
                            <button type="submit" class="btn btn-primary">æ›´æ–°ç¬”è®°</button>
                            <?php if (!empty($update_error)): ?>
                                <div class="alert alert-danger mt-3"><?php echo $update_error; ?></div>
                            <?php endif; ?>
                        </form>
                        <div class="text-center mt-3">
                            <a href="../settings.php" class="btn btn-link">è¿”å›è®¾ç½®</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\admin\edit_note.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\admin\edit_user.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•ä¸”æ˜¯ xiaoxuan ç”¨æˆ·
if (!isset($_SESSION['user_id']) || !isset($_SESSION['is_xiaoxuan']) || !$_SESSION['is_xiaoxuan']) {
    header("Location: ../index.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM users WHERE id = ?");
$stmt->execute([$id]);
$user = $stmt->fetch();

if (!$user) {
    die("ç”¨æˆ·ä¸å­˜åœ¨");
}

// å¤„ç†ç”¨æˆ·æ›´æ–°
$update_error = '';
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $username = $_POST['username'];
    $email = $_POST['email'];
    $role = $_POST['role'];
    $approved = isset($_POST['approved']) ? 1 : 0;

    // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    $stmt = $pdo->prepare("SELECT COUNT(*) FROM users WHERE username = ? AND id != ?");
    $stmt->execute([$username, $id]);
    
    if ($stmt->fetchColumn() > 0) {
        $update_error = "ç”¨æˆ·åå·²å­˜åœ¨";
    } else {
        try {
            $stmt = $pdo->prepare("UPDATE users SET username = ?, email = ?, role = ?, approved = ? WHERE id = ?");
            $stmt->execute([$username, $email, $role, $approved, $id]);
            header("Location: ../settings.php");
            exit();
        } catch (Exception $e) {
            $update_error = 'æ›´æ–°ç”¨æˆ·æ—¶å‡ºé”™: ' . $e->getMessage();
        }
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘ç”¨æˆ· - PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6 col-sm-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">ç¼–è¾‘ç”¨æˆ·</h3>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            <div class="mb-3">
                                <label for="username" class="form-label">ç”¨æˆ·å</label>
                                <input type="text" class="form-control" id="username" name="username" value="<?php echo htmlspecialchars($user['username']); ?>" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">é‚®ç®±</label>
                                <input type="email" class="form-control" id="email" name="email" value="<?php echo htmlspecialchars($user['email']); ?>" required>
                            </div>
                            <div class="mb-3">
                                <label for="role" class="form-label">è§’è‰²</label>
                                <select class="form-select" id="role" name="role">
                                    <option value="user" <?php echo $user['role'] === 'user' ? 'selected' : ''; ?>>æ™®é€šç”¨æˆ·</option>
                                    <option value="admin" <?php echo $user['role'] === 'admin' ? 'selected' : ''; ?>>ç®¡ç†å‘˜</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">çŠ¶æ€</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="approved" name="approved" <?php echo $user['approved'] ? 'checked' : ''; ?>>
                                    <label class="form-check-label" for="approved">
                                        å·²å®¡æ‰¹
                                    </label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">æ›´æ–°ç”¨æˆ·</button>
                            <?php if (!empty($update_error)): ?>
                                <div class="alert alert-danger mt-3"><?php echo $update_error; ?></div>
                            <?php endif; ?>
                        </form>
                        <div class="text-center mt-3">
                            <a href="../settings.php" class="btn btn-link">è¿”å›è®¾ç½®</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\admin\edit_user.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\admin\index.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
    header("Location: ../login.php");
    exit();
}

// è·å–æ‰€æœ‰ç¬”è®°
$notes = [];
try {
    $stmt = $pdo->query("SELECT * FROM notes ORDER BY created_at DESC");
    $notes = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch notes: " . $e->getMessage());
}

// è·å–æ‰€æœ‰ç”¨æˆ·
$users = [];
try {
    $stmt = $pdo->query("SELECT * FROM users ORDER BY created_at DESC");
    $users = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch users: " . $e->getMessage());
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - å±€åŸŸç½‘ç¬”è®°åä½œç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
        }
        .note-card {
            border-radius: 8px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link active" href="index.php">ç¬”è®°ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.php">ç”¨æˆ·ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.php">ç³»ç»Ÿè®¾ç½®</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>åå°ç®¡ç†</h2>
                <div class="row">
                    <div class="col-md-12">
                        <p>æ¬¢è¿ï¼Œ<a href="index.php" class="text-decoration-none"><?php echo htmlspecialchars($_SESSION['username']); ?></a></p>
                        <div class="mt-4">
                            <!-- ç¬”è®°ç®¡ç† -->
                            <h3>ç¬”è®°ç®¡ç†</h3>
                            <a href="create_note.php" class="btn btn-primary">æ–°å»ºç¬”è®°</a>
                            <div class="table-responsive mt-4">
                                <table class="table table-bordered">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>æ ‡é¢˜</th>
                                            <th>å†…å®¹</th>
                                            <th>åˆ›å»ºæ—¶é—´</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <?php foreach ($notes as $note): ?>
                                            <tr>
                                                <td><?php echo $note['id']; ?></td>
                                                <td><?php echo htmlspecialchars($note['title']); ?></td>
                                                <td><?php echo htmlspecialchars($note['content']); ?></td>
                                                <td><?php echo $note['created_at']; ?></td>
                                                <td>
                                                    <a href="edit_note.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                                                    <a href="delete_note.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')">åˆ é™¤</a>
                                                </td>
                                            </tr>
                                        <?php endforeach; ?>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\admin\index.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\admin\users.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯ç®¡ç†å‘˜
if (!isset($_SESSION['user_id']) || $_SESSION['role'] !== 'admin') {
    header("Location: ../login.php");
    exit();
}

// è·å–æ‰€æœ‰ç”¨æˆ·
$users = [];
try {
    $stmt = $pdo->query("SELECT * FROM users ORDER BY created_at DESC");
    $users = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch users: " . $e->getMessage());
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ç®¡ç† - å±€åŸŸç½‘ç¬”è®°åä½œç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.php">æˆ‘çš„ç¬”è®°</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="users.php">ç”¨æˆ·ç®¡ç†</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="settings.php">ç³»ç»Ÿè®¾ç½®</a>
                    </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>ç”¨æˆ·ç®¡ç†</h2>
                <div class="table-responsive mt-4">
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>é‚®ç®±</th>
                                <th>è§’è‰²</th>
                                <th>åˆ›å»ºæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <?php foreach ($users as $user): ?>
                                <tr>
                                    <td><?php echo $user['id']; ?></td>
                                    <td><?php echo htmlspecialchars($user['username']); ?></td>
                                    <td><?php echo htmlspecialchars($user['email']); ?></td>
                                    <td><?php echo $user['role']; ?></td>
                                    <td><?php echo $user['created_at']; ?></td>
                                    <td>
                                        <a href="edit_user.php?id=<?php echo $user['id']; ?>" class="btn btn-sm btn-primary">ç¼–è¾‘</a>
                                        <?php if ($user['username'] !== 'admin'): ?>
                                            <a href="delete_user.php?id=<?php echo $user['id']; ?>" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç”¨æˆ·å—ï¼Ÿ')">åˆ é™¤</a>
                                        <?php endif; ?>
                                    </td>
                                </tr>
                            <?php endforeach; ?>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\admin\users.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\desp\create.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

// è·å–çŸ¥è¯†åº“åˆ†ç±»
$categories = [];
try {
    $stmt = $pdo->query("SELECT * FROM knowledge_categories ORDER BY name ASC");
    $categories = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch knowledge categories: " . $e->getMessage());
}

// æ£€æŸ¥æ˜¯å¦æœ‰æ¥è‡ªKimiç¬”è®°åŠ©æ‰‹çš„è‡ªåŠ¨å¡«å……æ•°æ®ï¼ˆåœ¨$_POST['chat_title']å­˜åœ¨æ—¶ï¼‰
$auto_fill_title = '';
$auto_fill_content = '';
if (isset($_POST['chat_title'])) {
    $auto_fill_title = $_POST['chat_title'];
    $auto_fill_content = isset($_POST['chat_content']) ? $_POST['chat_content'] : '';
}

// å¤„ç†åˆ›å»ºç¬”è®°çš„é€»è¾‘ï¼ˆä»…åœ¨æ­£å¸¸æäº¤æ—¶ï¼‰
$create_error = '';
if ($_SERVER['REQUEST_METHOD'] == 'POST' && !isset($_POST['chat_title'])) {
    // å®‰å…¨åœ°è·å–æ‰€æœ‰POSTæ•°æ®
    $title = isset($_POST['title']) ? trim($_POST['title']) : '';
    $content = isset($_POST['content']) ? trim($_POST['content']) : '';
    $category_id = isset($_POST['category_id']) && $_POST['category_id'] !== '' ? $_POST['category_id'] : null;

    // åˆ é™¤å›¾ç‰‡å’Œæ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ï¼Œä½†ä¿ç•™ç©ºæ•°ç»„ä»¥å…¼å®¹æ•°æ®åº“
    $images = [];
    $files = [];

    if (empty($title)) {
        $create_error = 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º';
    } else {
        try {
            // ä¿ç•™åŸæœ‰æ’å…¥è¯­å¥ï¼Œç©ºæ•°ç»„ä¼šè‡ªåŠ¨è½¬ä¸ºJSON
            $stmt = $pdo->prepare("INSERT INTO knowledge_notes (user_id, category_id, title, content, images, files) VALUES (?, ?, ?, ?, ?, ?)");
            $stmt->execute([
                $_SESSION['user_id'],
                $category_id,
                $title,
                $content,
                json_encode($images),
                json_encode($files)
            ]);
            // ä¿®å¤ï¼šè·³è½¬åˆ°ä¸Šçº§ç›®å½•çš„index.php
            header("Location: ../knowledge/index.php");
            exit();
        } catch (Exception $e) {
            $create_error = 'åˆ›å»ºç¬”è®°æ—¶å‡ºé”™: ' . $e->getMessage();
        }
    }
}
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘ - åˆ›å»ºç¬”è®°</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico " type="image/x-icon">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-200px);
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 0;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-200px);
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content.active {
                margin-left: 200px;
            }
        }
        .delete-btn {
            margin-left: 10px;
        }
        /* æ·»åŠ è‡ªåŠ¨å¡«å……æç¤ºæ ·å¼ */
        .auto-fill-notice {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item active">
                        <!-- ä¿®å¤ï¼šè·³è½¬åˆ°ä¸Šçº§ç›®å½•çš„index.php -->
                        <a class="nav-link" href="index.html">çŸ¥è¯†åº“</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../recycle.php">å›æ”¶ç«™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../favorites.php">æ”¶è—</a>
                    </li>
					<li class="nav-item">
					    <a class="nav-link" href="index.html" target="_blank" rel="noopener noreferrer">AIæ™ºèƒ½ç¬”è®°</a>
					</li>
                    <?php if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']): ?>
                        <li class="nav-item">
                            <a class="nav-link" href="../settings.php">è®¾ç½®</a>
                        </li>
                    <?php endif; ?>
                   <li class="nav-item">
                         <a class="nav-link" href="../logout.php">é€€å‡ºç™»å½•</a>
                     </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>åˆ›å»ºç¬”è®°</h2>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <!-- æ˜¾ç¤ºè‡ªåŠ¨å¡«å……æç¤º -->
                        <?php if (!empty($auto_fill_title)): ?>
                            <div class="auto-fill-notice">
                                âœ¨ å·²æ™ºèƒ½ä»ç¬”è®°åŠ©æ‰‹ä¸­è‡ªåŠ¨å¡«å……å¯¹è¯å†…å®¹ï¼Œè¯·æ£€æŸ¥å¹¶å®Œå–„ä¿¡æ¯åæäº¤ã€‚
                            </div>
                        <?php endif; ?>
                        
                        <?php if (!empty($create_error)): ?>
                            <div class="alert alert-danger"><?php echo htmlspecialchars($create_error); ?></div>
                        <?php endif; ?>
                        
                        <form method="POST" action="">
                            <div class="mb-3">
                                <label for="title" class="form-label">æ ‡é¢˜</label>
                                <input type="text" class="form-control" id="title" name="title" required 
                                       value="<?php echo htmlspecialchars($auto_fill_title); ?>">
                            </div>
                            <div class="mb-3">
                                <label for="content" class="form-label">å†…å®¹</label>
                                <textarea class="form-control" id="content" name="content" rows="10" required><?php 
                                    echo htmlspecialchars($auto_fill_content); 
                                ?></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="category_id" class="form-label">åˆ†ç±»</label>
                                <select class="form-select" id="category_id" name="category_id">
                                    <option value="">é€‰æ‹©åˆ†ç±»</option>
                                    <?php foreach ($categories as $category): ?>
                                        <option value="<?php echo $category['id']; ?>"><?php echo htmlspecialchars($category['name']); ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <!-- åˆ é™¤å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½ -->
                            <!--
                            <div class="mb-3">
                                <label for="images" class="form-label">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¤šå¼ ï¼‰</label>
                                <input type="file" class="form-control" id="images" name="images[]" multiple>
                                <div id="imagePreviewContainer" class="mt-2"></div>
                            </div>
                            -->
                            <!-- åˆ é™¤æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½ -->
                            <!--
                            <div class="mb-3">
                                <label for="files" class="form-label">ä¸Šä¼ æ–‡ä»¶ï¼ˆå¤šä¸ªï¼‰</label>
                                <input type="file" class="form-control" id="files" name="files[]" multiple>
                            </div>
                            -->
                            <button type="submit" class="btn btn-primary">åˆ›å»ºç¬”è®°</button>
                            <!-- ä¿®å¤ï¼šè·³è½¬åˆ°ä¸Šçº§ç›®å½•çš„index.php -->
                            <a href="index.html" class="btn btn-primary">è¿”å›</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('active');
        }
		
        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ”¶èµ·ä¾§è¾¹æ 
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleButton = document.querySelector('.toggle-sidebar');

                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target) && window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        // ç‚¹å‡»ä¾§è¾¹æ ä¸­çš„é“¾æ¥æ—¶æ”¶èµ·ä¾§è¾¹æ 
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\desp\create.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\install\install.php ======= 
 
<?php
/**
 * Note Cloud å®‰è£…ç¨‹åº v2.6
 * ä¿®å¤æ¸…å•ï¼š
 * 1. æ·»åŠ  ob_start() é˜²æ­¢ headers already sent
 * 2. åœ¨ header() å‰æ¸…ç©ºç¼“å†²åŒº
 * 3. æ­¥éª¤3æ•è·æ‰€æœ‰æ•°æ®åº“é”™è¯¯
 * 4. æ­¥éª¤4å»¶è¿Ÿæ¸…ç©º Session
 * 5. æ·»åŠ  MySQL 8.0 è®¤è¯æ’ä»¶æ”¯æŒ
 */

// âœ… æ ¸å¿ƒä¿®å¤ï¼šå¿…é¡»åœ¨ç¬¬ä¸€è¡Œå¼€å¯è¾“å‡ºç¼“å†²
ob_start();

error_reporting(E_ALL);
ini_set('display_errors', 1);
session_start();

// ==================== æ ¸å¿ƒé…ç½® ====================
define('BASE_PATH', dirname(__DIR__));
define('INSTALL_PATH', __DIR__);
define('CONFIG_DIR', BASE_PATH . '/includes/');
define('CONFIG_PATH', CONFIG_DIR . 'config.php');
define('LOCK_PATH', BASE_PATH . '/install.lock');

// æ£€æŸ¥æ˜¯å¦å·²å®‰è£…
if (file_exists(LOCK_PATH)) {
    exit('
    <div style="text-align:center; padding:50px; font-family:sans-serif; background:#f8f9fa; border-radius:10px; max-width:600px; margin:50px auto;">
        <h2>âš ï¸ ç³»ç»Ÿå·²å®‰è£…</h2>
        <p>å¦‚éœ€é‡æ–°å®‰è£…ï¼Œè¯·åˆ é™¤ç½‘ç«™æ ¹ç›®å½•ä¸‹çš„ <code>install.lock</code> æ–‡ä»¶</p>
        <a href="../login.php" class="btn btn-primary">è¿”å›é¦–é¡µ</a>
    </div>');
}

$step = filter_input(INPUT_GET, 'step', FILTER_VALIDATE_INT, ['options' => ['default' => 1, 'min_range' => 1, 'max_range' => 4]]);
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Note Cloud - å®‰è£…å‘å¯¼</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .container { max-width: 850px; margin: 0 auto; background: white; border-radius: 15px; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        .step-header { background: linear-gradient(45deg, #007bff, #0056b3); color: white; padding: 30px; text-align: center; }
        .step-header h2 { margin: 0; font-size: 28px; font-weight: bold; }
        .step-header p { margin: 10px 0 0; opacity: 0.9; }
        .step-indicator { display: flex; justify-content: space-between; padding: 20px 30px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; }
        .step-item { flex: 1; text-align: center; padding: 10px; margin: 0 5px; background: #e9ecef; border-radius: 5px; font-weight: 500; }
        .step-item.active { background: #007bff; color: white; }
        .step-content { padding: 40px; }
        .form-section { background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px; border-left: 5px solid #007bff; }
        .form-title { color: #007bff; font-weight: bold; font-size: 18px; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { font-weight: 600; margin-bottom: 8px; color: #495057; }
        .form-control { padding: 12px; border-radius: 8px; border: 2px solid #dee2e6; transition: all 0.3s; }
        .form-control:focus { border-color: #80bdff; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); outline: none; }
        .btn-primary, .btn-success, .btn-info { padding: 12px 30px; font-size: 16px; font-weight: 600; border-radius: 8px; transition: all 0.3s; }
        .btn-primary:hover, .btn-success:hover, .btn-info:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-block { width: 100%; padding: 15px; font-size: 18px; }
        .alert { border-radius: 8px; border: none; }
        .validation-message { font-size: 13px; margin-top: 5px; padding: 8px; border-radius: 5px; display: none; }
        .validation-success { color: #155724; background: #d4edda; display: block !important; }
        .validation-error { color: #721c24; background: #f8d7da; display: block !important; }
        .install-progress { padding: 20px 0; }
        .log-container { min-height: 50px; max-height: 400px; overflow-y: auto; }
        .log-container .alert { margin: 8px 0; padding: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="step-indicator">
            <div class="step-item <?= ($step >= 1 ? 'active' : '') ?>">1. ç¯å¢ƒæ£€æµ‹</div>
            <div class="step-item <?= ($step >= 2 ? 'active' : '') ?>">2. é…ç½®ä¿¡æ¯</div>
            <div class="step-item <?= ($step >= 3 ? 'active' : '') ?>">3. æ•°æ®åº“å®‰è£…</div>
            <div class="step-item <?= ($step >= 4 ? 'active' : '') ?>">4. å®‰è£…å®Œæˆ</div>
        </div>

        <div class="step-content">
            <?php
            // ==================== æ­¥éª¤1ï¼šç¯å¢ƒæ£€æµ‹ ====================
            if ($step == 1):
                $check = [];
                $install = true;

                if (version_compare(PHP_VERSION, '7.1.0', '<')) {
                    $check['php'] = ['status' => 'danger', 'msg' => 'PHPç‰ˆæœ¬è¿‡ä½ï¼ˆ' . PHP_VERSION . 'ï¼‰ï¼Œéœ€è¦7.1+'];
                    $install = false;
                } else {
                    $check['php'] = ['status' => 'success', 'msg' => 'PHPç‰ˆæœ¬ ' . PHP_VERSION];
                }

                if (extension_loaded('pdo') && extension_loaded('pdo_mysql')) {
                    $check['pdo'] = ['status' => 'success', 'msg' => 'PDO_MYSQL æ”¯æŒ'];
                } else {
                    $check['pdo'] = ['status' => 'danger', 'msg' => 'PDO_MYSQL æœªå®‰è£…'];
                    $install = false;
                }

                $dirs_to_check = [
                    CONFIG_DIR => 'includesç›®å½•ï¼ˆé…ç½®æ–‡ä»¶ï¼‰',
                ];
                
                foreach ($dirs_to_check as $dir => $name) {
                    if (!is_dir($dir)) {
                        if (!@mkdir($dir, 0755, true)) {
                            $check['dir_' . md5($dir)] = ['status' => 'danger', 'msg' => "$name ä¸å­˜åœ¨ä¸”æ— æ³•è‡ªåŠ¨åˆ›å»º"];
                            $install = false;
                        } else {
                            $check['dir_' . md5($dir)] = ['status' => 'success', 'msg' => "$name å·²è‡ªåŠ¨åˆ›å»º"];
                        }
                    } elseif (is_writable($dir)) {
                        $check['dir_' . md5($dir)] = ['status' => 'success', 'msg' => "$name å¯å†™"];
                    } else {
                        $check['dir_' . md5($dir)] = ['status' => 'warning', 'msg' => "$name ä¸å¯å†™ï¼ˆè¯·æ‰‹åŠ¨è®¾ç½®755æƒé™ï¼‰"];
                    }
                }
            ?>

                <h3 class="mb-4"><i class="fas fa-cogs"></i> ç¯å¢ƒæ£€æµ‹</h3>
                <p class="text-muted mb-4">è¯·ç¡®ä¿ä»¥ä¸‹ç¯å¢ƒè¦æ±‚å·²æ»¡è¶³</p>

                <ul class="list-group mb-4">
                    <?php foreach ($check as $item): ?>
                    <li class="list-group-item">
                        <?= htmlspecialchars($item['msg']) ?>
                        <span class="badge badge-<?= $item['status'] ?> badge-pill">
                            <?= $item['status'] == 'success' ? 'âœ“' : ($item['status'] == 'warning' ? '!' : 'âœ—') ?>
                        </span>
                    </li>
                    <?php endforeach; ?>
                </ul>

                <?php if ($install): ?>
                    <a href="?step=2" class="btn btn-success btn-block">æ£€æµ‹é€šè¿‡ï¼Œå¼€å§‹é…ç½®</a>
                <?php else: ?>
                    <div class="alert alert-danger">è¯·è§£å†³ä»¥ä¸Šé—®é¢˜ååˆ·æ–°é¡µé¢é‡è¯•</div>
                <?php endif; ?>

            <?php
            // ==================== æ­¥éª¤2ï¼šé…ç½®è¡¨å• ====================
            elseif ($step == 2):
                $db = $_SESSION['db'] ?? ['host' => 'localhost', 'port' => '3306', 'name' => 'note_cloud'];
                $admin = $_SESSION['admin'] ?? ['username' => 'admin'];
            ?>

                <h3 class="mb-4"><i class="fas fa-wrench"></i> é…ç½®ä¿¡æ¯</h3>
                <p class="text-muted mb-4">è¯·å¡«å†™æ•°æ®åº“å’Œç®¡ç†å‘˜ä¿¡æ¯</p>

                <?php if (isset($_SESSION['install_error'])): ?>
                    <div class="alert alert-danger">
                        <strong>é”™è¯¯ï¼š</strong> <?= htmlspecialchars($_SESSION['install_error']) ?>
                    </div>
                    <?php unset($_SESSION['install_error']); ?>
                <?php endif; ?>

                <form method="post" action="?step=3&run=1" id="installForm">
                    <!-- æ•°æ®åº“é…ç½® -->
                    <div class="form-section">
                        <div class="form-title">ğŸ“Š æ•°æ®åº“è®¾ç½®</div>
                        <div class="form-group">
                            <label>æ•°æ®åº“åœ°å€</label>
                            <input type="text" class="form-control" name="db_host" value="<?= htmlspecialchars($db['host']) ?>" required placeholder="localhost">
                        </div>
                        <div class="form-group">
                            <label>æ•°æ®åº“ç«¯å£</label>
                            <input type="text" class="form-control" name="db_port" value="<?= htmlspecialchars($db['port']) ?>" required placeholder="3306">
                        </div>
                        <div class="form-group">
                            <label>æ•°æ®åº“ç”¨æˆ·å</label>
                            <input type="text" class="form-control" name="db_user" value="<?= htmlspecialchars($db['user']) ?>" required>
                        </div>
                        <div class="form-group">
                            <label>æ•°æ®åº“å¯†ç </label>
                            <input type="password" class="form-control" name="db_pass" value="<?= htmlspecialchars($db['pass'] ?? '') ?>" required>
                            <div class="alert alert-warning" style="margin-top: 10px;">
                                <strong>MySQL 8.0 ç”¨æˆ·æ³¨æ„ï¼š</strong><br>
                                å¦‚æœå‡ºç° 2054 é”™è¯¯ï¼Œè¯·åœ¨å®‰è£…å‰æ‰§è¡Œ SQLï¼š<br>
                                <code>ALTER USER '<?=htmlspecialchars($_POST['db_user']??'root')?>'@'localhost' IDENTIFIED WITH mysql_native_password BY 'ä½ çš„å¯†ç '; FLUSH PRIVILEGES;</code>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>æ•°æ®åº“åç§°</label>
                            <input type="text" class="form-control" name="db_name" value="<?= htmlspecialchars($db['name']) ?>" required placeholder="å°†è‡ªåŠ¨åˆ›å»º">
                        </div>
                    </div>

                    <!-- ç®¡ç†å‘˜é…ç½® -->
                    <div class="form-section">
                        <div class="form-title">ğŸ‘‘ ç®¡ç†å‘˜è´¦å·</div>
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" class="form-control" name="admin_user" value="<?= htmlspecialchars($admin['username']) ?>" required pattern="[a-zA-Z0-9_]{3,20}">
                            <small class="text-muted">3-20ä½å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿</small>
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input type="password" class="form-control" name="admin_pass" id="adminPass" required minlength="6">
                            <div class="validation-message" id="passwordMessage">è‡³å°‘6ä½å­—ç¬¦</div>
                        </div>
                        <div class="form-group">
                            <label>ç¡®è®¤å¯†ç </label>
                            <input type="password" class="form-control" name="admin_pass2" id="adminPass2" required minlength="6">
                            <div class="validation-message" id="password2Message"></div>
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±</label>
                            <input type="email" class="form-control" name="admin_email" value="<?= htmlspecialchars($admin['email']) ?>" required>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-success btn-block" id="submitBtn">
                        â–¶ å¼€å§‹å®‰è£…
                    </button>
                </form>

                <script>
                // å¯†ç éªŒè¯è„šæœ¬
                const password = document.getElementById('adminPass');
                const password2 = document.getElementById('adminPass2');
                const passwordMessage = document.getElementById('passwordMessage');
                const password2Message = document.getElementById('password2Message');
                const submitBtn = document.getElementById('submitBtn');

                function validateForm() {
                    const pwd1 = password.value;
                    const pwd2 = password2.value;
                    let isValid = true;

                    // å¯†ç é•¿åº¦
                    if (pwd1.length > 0 && pwd1.length < 6) {
                        passwordMessage.textContent = 'âŒ å¯†ç é•¿åº¦è‡³å°‘6ä½';
                        passwordMessage.className = 'validation-message validation-error';
                        isValid = false;
                    } else if (pwd1.length >= 6) {
                        passwordMessage.textContent = 'âœ“ å¯†ç å¼ºåº¦ç¬¦åˆè¦æ±‚';
                        passwordMessage.className = 'validation-message validation-success';
                    } else {
                        passwordMessage.style.display = 'none';
                    }

                    // å¯†ç åŒ¹é…
                    if (pwd2.length > 0 && pwd1 !== pwd2) {
                        password2Message.textContent = 'âŒ ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´';
                        password2Message.className = 'validation-message validation-error';
                        isValid = false;
                    } else if (pwd2.length > 0 && pwd1 === pwd2) {
                        password2Message.textContent = 'âœ“ å¯†ç åŒ¹é…';
                        password2Message.className = 'validation-message validation-success';
                    } else {
                        password2Message.style.display = 'none';
                    }

                    submitBtn.disabled = !isValid;
                    return isValid;
                }

                password.addEventListener('input', validateForm);
                password2.addEventListener('input', validateForm);

                document.getElementById('installForm').addEventListener('submit', function(e) {
                    if (!validateForm()) {
                        e.preventDefault();
                        alert('è¯·æ£€æŸ¥å¯†ç è®¾ç½®æ˜¯å¦æ­£ç¡®ï¼');
                        return false;
                    }
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = 'â³ å®‰è£…ä¸­ï¼Œè¯·ç¨å€™...';
                });
                </script>

            <?php
            // ==================== æ­¥éª¤3ï¼šæ‰§è¡Œå®‰è£…ï¼ˆå®Œå…¨ä¿®å¤ç‰ˆï¼‰ ====================
            elseif ($step == 3):
                // âœ… å…ˆæ˜¾ç¤ºåŠ è½½ç•Œé¢
                ?>
                <div class="install-progress">
                    <h3 class="mb-4"><i class="fas fa-spinner fa-spin"></i> æ­£åœ¨å®‰è£…ç³»ç»Ÿ...</h3>
                    <div class="progress mb-3" style="height:30px; border-radius:8px;">
                        <div id="installProgress" class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
                             style="width:5%; font-size:14px; font-weight:bold;">
                            å‡†å¤‡ä¸­...
                        </div>
                    </div>
                    <div id="installLog" class="log-container"></div>
                </div>
                <?php
                
                // âœ… å®‰å…¨çš„ $log å‡½æ•°å®šä¹‰
                $log = function($msg, $type = 'info') {
                    $icon = $type == 'success' ? 'âœ“' : ($type == 'error' ? 'âœ—' : 'â†’');
                    $safeMsg = json_encode($icon . ' ' . $msg, JSON_UNESCAPED_UNICODE);
                    echo "<script>
                        try {
                            var div = document.createElement('div');
                            div.className = 'alert alert-{$type}';
                            div.style.margin = '8px 0';
                            div.style.padding = '10px';
                            div.style.fontSize = '14px';
                            div.innerHTML = {$safeMsg};
                            var logContainer = document.getElementById('installLog');
                            if(logContainer) {
                                logContainer.appendChild(div);
                                logContainer.scrollTop = logContainer.scrollHeight;
                            }
                        } catch(e) { console.error('æ—¥å¿—é”™è¯¯:', e); }
                    </script>";
                    ob_flush(); flush();
                };

                // âœ… å®é™…å®‰è£…é€»è¾‘
                if (isset($_GET['run']) && $_GET['run'] == '1') {
                    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
                        header('Location: ?step=2');
                        exit;
                    }

                    // éªŒè¯å¯†ç 
                    if ($_POST['admin_pass'] !== $_POST['admin_pass2']) {
                        $log('âŒ ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', 'error');
                        echo '<a href="?step=2" class="btn btn-info btn-block mt-4">è¿”å›ä¿®æ”¹</a>';
                        exit;
                    }

                    try {
                        // âœ… MySQL 8.0 è®¤è¯æ’ä»¶
                        $dsn = "mysql:host={$_POST['db_host']};port={$_POST['db_port']};charset=utf8mb4;auth_plugin=mysql_native_password";
                        $pdo = new PDO($dsn, $_POST['db_user'], $_POST['db_pass'], [
                            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION
                        ]);

                        $dbName = $_POST['db_name'];
                        $pdo->exec("CREATE DATABASE IF NOT EXISTS `$dbName` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci");
                        $log('âœ“ æ•°æ®åº“åˆ›å»ºæˆåŠŸ', 'success');

                        $pdo->beginTransaction();
                        $pdo->exec("USE `$dbName`");
                        
                        // åˆ›å»ºæ•°æ®è¡¨
                        try {
                            createTables($pdo, $log);
                        } catch (Exception $e) {
                            throw new Exception("æ•°æ®è¡¨åˆ›å»ºå¤±è´¥: " . $e->getMessage());
                        }

                        // åˆ›å»ºç®¡ç†å‘˜
                        $passwordHash = password_hash($_POST['admin_pass'], PASSWORD_BCRYPT, ['cost' => 12]);
                        $stmt = $pdo->prepare("INSERT INTO users (username, password_hash, email, role, status, approved, created_at) VALUES (?, ?, ?, 'admin', 1, 1, NOW())");
                        $stmt->execute([$_POST['admin_user'], $passwordHash, $_POST['admin_email']]);
                        $log('âœ“ ç®¡ç†å‘˜è´¦å·åˆ›å»ºæˆåŠŸ', 'success');

                        $pdo->commit();

                        // âœ… ç”ŸæˆåŒ…å« PDO çš„é…ç½®æ–‡ä»¶
                        if (!is_dir(CONFIG_DIR)) {
                            mkdir(CONFIG_DIR, 0755, true);
                        }
                        
                        $configContent = '<?php' . "\n";
                        $configContent .= '/* Note Cloud æ•°æ®åº“é…ç½® - è‡ªåŠ¨ç”Ÿæˆäº ' . date('Y-m-d H:i:s') . ' */' . "\n";
                        $configContent .= "if (!defined('IN_SYSTEM')) exit('Access Denied');\n\n";
                        $configContent .= '$dbconfig = array(' . "\n";
                        $configContent .= "    'host' => '" . addslashes($_POST['db_host']) . "',\n";
                        $configContent .= "    'port' => " . intval($_POST['db_port']) . ",\n";
                        $configContent .= "    'user' => '" . addslashes($_POST['db_user']) . "',\n";
                        $configContent .= "    'pwd' => '" . addslashes($_POST['db_pass']) . "',\n";
                        $configContent .= "    'dbname' => '" . addslashes($_POST['db_name']) . "'\n";
                        $configContent .= ');' . "\n\n";
                        $configContent .= <<<'PDO_CODE'
                        
                        // è‡ªåŠ¨åˆ›å»º PDO æ•°æ®åº“è¿æ¥ï¼ˆæ‰€æœ‰é¡µé¢ç›´æ¥ä½¿ç”¨ $pdoï¼‰
                        try {
                            $pdo = new PDO(
                                "mysql:host={$dbconfig['host']};port={$dbconfig['port']};dbname={$dbconfig['dbname']};charset=utf8mb4",
                                $dbconfig['user'],
                                $dbconfig['pwd'],
                                [
                                    PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
                                    PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
                                    PDO::ATTR_EMULATE_PREPARES => false,
                                    PDO::MYSQL_ATTR_INIT_COMMAND => "SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci"
                                ]
                            );
                        } catch (PDOException $e) {
                            error_log("PDO Connection Error: " . $e->getMessage());
                            die('<div style="text-align:center; padding:50px;"><h2>âš ï¸ ç³»ç»Ÿç»´æŠ¤ä¸­</h2><p>æ•°æ®åº“è¿æ¥å‡ºç°é—®é¢˜</p></div>');
                        }
                        
                        PDO_CODE;
                        
                        if (file_put_contents(CONFIG_PATH, $configContent) === false) {
                            throw new Exception('é…ç½®æ–‡ä»¶å†™å…¥å¤±è´¥');
                        }
                        chmod(CONFIG_PATH, 0644);
                        $log('âœ“ é…ç½®æ–‡ä»¶åˆ›å»ºæˆåŠŸ', 'success');

                        // âœ… åˆ›å»ºåŒ…å«å®‰è£…ä¿¡æ¯çš„é”æ–‡ä»¶
                        $installInfo = [
                            'installed' => true,
                            'version' => '1.0.0',
                            'installed_at' => date('Y-m-d H:i:s'),
                            'installed_by' => $_SERVER['REMOTE_ADDR'],
                            'db_name' => $_POST['db_name'],
                            'admin_user' => $_POST['admin_user']
                        ];
                        $lockContent = '<?php return ' . var_export($installInfo, true) . ';';
                        if (file_put_contents(LOCK_PATH, $lockContent) === false) {
                            throw new Exception('æ— æ³•åˆ›å»ºå®‰è£…é”æ–‡ä»¶');
                        }
                        $log('âœ“ å®‰è£…é”åˆ›å»ºæˆåŠŸ', 'success');

                        // âœ… å…³é”®ä¿®å¤ï¼šæ¸…ç©ºç¼“å†²åŒºå†è·³è½¬
                        ob_end_clean();
                        echo "<script>window.location.href='?step=4';</script>";  // âœ… JSè·³è½¬ï¼Œä¸å—è¾“å‡ºé™åˆ¶
                        exit;

                    } catch (PDOException $e) {
                        if (isset($pdo) && $pdo->inTransaction()) {
                            $pdo->rollBack();
                        }
                        $log('âœ— æ•°æ®åº“é”™è¯¯: ' . $e->getMessage(), 'error');
                        echo '<a href="?step=2" class="btn btn-info btn-block mt-4">è¿”å›ä¿®æ”¹é…ç½®</a>';
                        exit;
                    } catch (Exception $e) {
                        $log('âœ— å®‰è£…å¤±è´¥: ' . $e->getMessage(), 'error');
                        echo '<a href="?step=2" class="btn btn-info btn-block mt-4">è¿”å›ä¿®æ”¹é…ç½®</a>';
                        exit;
                    }
                }
            ?>

            <?php
            // ==================== æ­¥éª¤4ï¼šå®Œæˆ ====================
            elseif ($step == 4):
                if (!file_exists(LOCK_PATH)) {
                    header('Location: ?step=1');
                    exit;
                }
            
                // âœ… åŒé‡ä¿é™©è¯»å–å®‰è£…ä¿¡æ¯
                $dbName = $_SESSION['db']['name'] ?? 'æœªçŸ¥';
                $adminUser = $_SESSION['admin']['username'] ?? 'æœªçŸ¥';
                $adminEmail = $_SESSION['admin']['email'] ?? 'æœªçŸ¥';
                
                // âœ… ä»é”æ–‡ä»¶è¯»å–
                $installInfo = @include(LOCK_PATH);
                if (is_array($installInfo)) {
                    $dbName = $installInfo['db_name'] ?? $dbName;
                    $adminUser = $installInfo['admin_user'] ?? $adminUser;
                }
                ?>
            
                <h3 class="mb-4"><i class="fas fa-check-circle"></i> ğŸ‰ å®‰è£…å®Œæˆ</h3>
                
                <div class="alert alert-success">
                    <h4>ç³»ç»Ÿå·²æˆåŠŸå®‰è£…ï¼</h4>
                    <ul class="mb-0">
                        <li>æ•°æ®åº“ï¼š<strong><?= htmlspecialchars($dbName) ?></strong></li>
                        <li>ç®¡ç†å‘˜ï¼š<strong><?= htmlspecialchars($adminUser) ?></strong>ï¼ˆå·²è‡ªåŠ¨å®¡æ‰¹ï¼‰</li>
                        <li>ç®¡ç†å‘˜é‚®ç®±ï¼š<strong><?= htmlspecialchars($adminEmail) ?></strong></li>
                    </ul>
                </div>
            
                <div class="card border-warning mb-4">
                    <div class="card-header bg-warning text-white font-weight-bold">âš ï¸ å®‰å…¨æé†’</div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <li>è¯·å¦¥å–„ä¿ç®¡ç®¡ç†å‘˜å¯†ç </li>
                            <li><strong>å»ºè®®ç«‹å³åˆ é™¤ install/ ç›®å½•</strong></li>
                            <li>é…ç½®æ–‡ä»¶å·²ç”Ÿæˆï¼š<code>includes/config.php</code></li>
                            <li>å®‰è£…é”æ–‡ä»¶ï¼š<code><?= LOCK_PATH ?></code></li>
                        </ol>
                    </div>
                </div>
            
                <div class="row">
                    <div class="col-md-6">
                        <a href="../" class="btn btn-primary btn-block">è¿›å…¥ç³»ç»Ÿ</a>
                    </div>
                    <div class="col-md-6">
                        <a href="../login.php" class="btn btn-success btn-block">å‰å¾€ç™»å½•</a>
                    </div>
                </div>
            
                <?php
                // âœ… å…³é”®ä¿®å¤ï¼šåœ¨æ˜¾ç¤ºå®Œæˆåå†æ¸…ç©º session
                unset($_SESSION['db'], $_SESSION['admin']);
                ?>
            <?php endif; ?>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html>

<?php
/**
 * âœ… åˆ›å»ºæ‰€æœ‰æ•°æ®è¡¨ï¼ˆåŒ…å«approvedå­—æ®µï¼‰
 */
function createTables(PDO $pdo, callable $log) {
    $tables = [
        // ç”¨æˆ·è¡¨
        "CREATE TABLE IF NOT EXISTS users (
            id INT AUTO_INCREMENT PRIMARY KEY,
            username VARCHAR(255) NOT NULL UNIQUE,
            password_hash VARCHAR(255) NOT NULL,
            email VARCHAR(255) NOT NULL UNIQUE,
            role VARCHAR(50) NOT NULL DEFAULT 'user',
            status TINYINT(1) NOT NULL DEFAULT 1,
            approved TINYINT(1) NOT NULL DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            INDEX idx_username (username),
            INDEX idx_email (email),
            INDEX idx_role (role),
            INDEX idx_status (status),
            INDEX idx_approved (approved)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4",

        // çŸ¥è¯†åˆ†ç±»è¡¨
        "CREATE TABLE IF NOT EXISTS knowledge_categories (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            user_id INT NOT NULL,
            description TEXT,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            INDEX idx_user_id (user_id),
            INDEX idx_name (name)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4",

        // æ ‡ç­¾è¡¨
        "CREATE TABLE IF NOT EXISTS note_tags (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            user_id INT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            INDEX idx_user_id (user_id),
            INDEX idx_name (name),
            UNIQUE KEY uk_user_tag (user_id, name)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4",

        // çŸ¥è¯†æ ‡ç­¾è¡¨
        "CREATE TABLE IF NOT EXISTS knowledge_note_tags (
            id INT AUTO_INCREMENT PRIMARY KEY,
            name VARCHAR(255) NOT NULL,
            user_id INT NOT NULL,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            INDEX idx_user_id (user_id),
            INDEX idx_name (name),
            UNIQUE KEY uk_user_tag (user_id, name)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4",

        // ç¬”è®°è¡¨
        "CREATE TABLE IF NOT EXISTS notes (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            title VARCHAR(255) NOT NULL,
            content LONGTEXT NOT NULL,
            category_id INT DEFAULT NULL,
            status TINYINT(1) DEFAULT 1,
            is_deleted TINYINT(1) DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            deleted_at TIMESTAMP NULL DEFAULT NULL,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (category_id) REFERENCES knowledge_categories(id) ON DELETE SET NULL,
            INDEX idx_user_id (user_id),
            INDEX idx_category_id (category_id),
            INDEX idx_status (status),
            INDEX idx_created_at (created_at),
            FULLTEXT idx_title_content (title, content)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4",

        // çŸ¥è¯†ç¬”è®°è¡¨
        "CREATE TABLE IF NOT EXISTS knowledge_notes (
            id INT AUTO_INCREMENT PRIMARY KEY,
            user_id INT NOT NULL,
            category_id INT DEFAULT NULL,
            title VARCHAR(255) NOT NULL,
            content LONGTEXT NOT NULL,
            image_path VARCHAR(500) DEFAULT NULL,
            file_path VARCHAR(500) DEFAULT NULL,
            status TINYINT(1) DEFAULT 1,
            view_count INT DEFAULT 0,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
            FOREIGN KEY (category_id) REFERENCES knowledge_categories(id) ON DELETE SET NULL,
            INDEX idx_user_id (user_id),
            INDEX idx_category_id (category_id),
            INDEX idx_status (status),
            INDEX idx_created_at (created_at),
            FULLTEXT idx_title_content (title, content)
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4",
    ];

    foreach ($tables as $sql) {
        try {
            $pdo->exec($sql);
            if (preg_match('/CREATE TABLE IF NOT EXISTS\s+`?(\w+)`?/i', $sql, $matches)) {
                $log("âœ“ è¡¨ {$matches[1]} åˆ›å»ºæˆåŠŸ", 'success');
            }
        } catch (PDOException $e) {
            throw new Exception("åˆ›å»ºè¡¨å¤±è´¥: " . $e->getMessage());
        }
    }
} 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\install\install.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\add_category.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

// å¤„ç†æ·»åŠ åˆ†ç±»
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $name = $_POST['name'] ?? '';
    
    $userId = $_SESSION['user_id']; // å‡è®¾æ¯ä¸ªç”¨æˆ·åªèƒ½æ·»åŠ è‡ªå·±çš„åˆ†ç±»

    try {
        // æ’å…¥åˆ†ç±»ä¿¡æ¯åˆ°æ•°æ®åº“
        $stmt = $pdo->prepare("INSERT INTO knowledge_categories (name, user_id) VALUES (?, ?)");
        $stmt->execute([$name, $userId]);
        
        // æ·»åŠ æˆåŠŸåï¼Œé‡å®šå‘åˆ†ç±»ç®¡ç†é¡µé¢
        header("Location: ../knowledge/categories.php");
        exit();
    } catch (Exception $e) {
        error_log("Failed to add category: " . $e->getMessage());
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ï¼ˆåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½éœ€è¦æ›´ä¼˜é›…åœ°å¤„ç†é”™è¯¯æ˜¾ç¤ºï¼‰
        echo "æ·»åŠ åˆ†ç±»å¤±è´¥ï¼š" . $e->getMessage();
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-sm-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">æ·»åŠ æ–°åˆ†ç±»</h3>
                    </div>
                    <div class="card-body">
                        <form method="POST">
                            <div class="mb-3">
                                <label for="name" class="form-label">åˆ†ç±»åç§°</label>
                                <input type="text" class="form-control" id="name" name="name" value="<?php echo htmlspecialchars($name ?? ''); ?>" required>
                            </div>
                            <button type="submit" class="btn btn-primary">æ·»åŠ </button>
                            <a href="categories.php" class="btn btn-secondary">è¿”å›</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\add_category.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\categories.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

// è·å–åˆ†ç±»
$categories = [];
try {
    if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']) {
    $stmt = $pdo->query("SELECT * FROM knowledge_categories ORDER BY name ASC");
} else {
    $stmt = $pdo->prepare("SELECT * FROM knowledge_categories WHERE user_id = ? ORDER BY name ASC");
    $stmt->execute([$_SESSION['user_id']]);
}

$categories = $stmt->fetchAll();
}
 catch (Exception $e) {
    error_log("Failed to fetch categories: " . $e->getMessage());
}

// å¤„ç†åˆ é™¤åˆ†ç±»
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['delete_category'])) {
    $categoryId = $_POST['category_id'];
    try {
        if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']) {
    $stmt = $pdo->prepare("DELETE FROM knowledge_categories WHERE id = ?");
    $stmt->execute([$categoryId]);
} else {
    $stmt = $pdo->prepare("DELETE FROM knowledge_categories WHERE id = ? AND user_id = ?");
    $stmt->execute([$categoryId, $_SESSION['user_id']]);
}
        header("Location: categories.php");
        exit();
    }
     catch (Exception $e) {
        error_log("Failed to delete category: " . $e->getMessage());
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>	
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
    <style>
        .justify-content-between {
            display:flex;
            justify-content: space-between !important;
        }
        .width{
            width:20%
        }
		
    </style> 
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 col-sm-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h3 class="mb-">ç®¡ç†åˆ†ç±»</h3>
                        <div class="justify-content-between ">
                            <a href="index.php" class="btn btn-primary">è¿”å›</a>
                            <a href="add_category.php" class="btn btn-primary">æ·»åŠ åˆ†ç±»</a>
                        </div>
                        
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>åç§°</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <?php foreach ($categories as $category): ?>
                                        <tr>
                                            <td><?php echo $category['id']; ?></td>
                                            <td><?php echo htmlspecialchars($category['name']); ?></td>
                                            <td>
                                                <form method="POST" action="" style="display: inline;">
                                                    <input type="hidden" name="category_id" value="<?php echo $category['id']; ?>">
                                                    <input type="hidden" name="delete_category" value="1">
                                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†ç±»å—ï¼Ÿ')">åˆ é™¤</button>
                                                </form>
                                            </td>
                                        </tr>
                                    <?php endforeach; ?>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\categories.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\create.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

// è·å–çŸ¥è¯†åº“åˆ†ç±»
$categories = [];
try {
    $stmt = $pdo->query("SELECT * FROM knowledge_categories ORDER BY name ASC");
    $categories = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch knowledge categories: " . $e->getMessage());
}

// å¤„ç†åˆ›å»ºç¬”è®°çš„é€»è¾‘
$create_error = '';
$content = isset($_POST['content']) ? nl2br($_POST['content']) : '';
if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    $title = $_POST['title'];
    $content = $_POST['content'];
    $category_id = $_POST['category_id'] ?? null;

    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    $images = [];
    if (!empty($_FILES['images']['name'])) {
        $target_dir = "uploads/images/"; // ç›´æ¥å­˜å‚¨åœ¨uploads/images/
        if (!is_dir($target_dir)) {
            mkdir($target_dir, 0777, true);
        }
        foreach ($_FILES['images']['name'] as $index => $name) {
            $target_file = $target_dir . basename($name);
            $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));
            $allowed_types = ['jpg', 'jpeg', 'png', 'gif'];
            if (in_array($imageFileType, $allowed_types)) {
                if (move_uploaded_file($_FILES["images"]["tmp_name"][$index], $target_file)) {
                    $images[] = $target_file;
                }
            }
        }
    }

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    $files = [];
    if (!empty($_FILES['files']['name'])) {
        $target_dir = "uploads/files/"; // ç›´æ¥å­˜å‚¨åœ¨uploads/files/
        if (!is_dir($target_dir)) {
            mkdir($target_dir, 0777, true);
        }
        foreach ($_FILES['files']['name'] as $index => $name) {
            $target_file = $target_dir . basename($name);
            if (move_uploaded_file($_FILES["files"]["tmp_name"][$index], $target_file)) {
                $files[] = $target_file;
            }
        }
    }

    if (empty($title)) {
        $create_error = 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º';
    } else {
        try {
            $stmt = $pdo->prepare("INSERT INTO knowledge_notes (user_id, category_id, title, content, images, files) VALUES (?, ?, ?, ?, ?, ?)");
            $stmt->execute([
                $_SESSION['user_id'],
                $category_id,
                $title,
                $content,
                json_encode($images),
                json_encode($files)
            ]);
            header("Location: index.php");
            exit();
        } catch (Exception $e) {
            $create_error = 'åˆ›å»ºç¬”è®°æ—¶å‡ºé”™: ' . $e->getMessage();
        }
    }
}
?>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-200px);
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 0;
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-200px);
            }
            .main-content {
                margin-left: 0;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content.active {
                margin-left: 200px;
            }
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-bottom: 10px;
        }
        .delete-btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.php">çŸ¥è¯†åº“</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../recycle.php">å›æ”¶ç«™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../favorites.php">æ”¶è—</a>
                    </li>
					<li class="nav-item">
					    <a class="nav-link" href="desp/index.html" target="_blank" rel="noopener noreferrer">ai</a>
					</li>
                    <?php if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']): ?>
                        <li class="nav-item">
                            <a class="nav-link" href="../settings.php">è®¾ç½®</a>
                        </li>
                    <?php endif; ?>
                   <li class="nav-item">
                         <a class="nav-link" href="../logout.php">é€€å‡ºç™»å½•</a>
                     </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>åˆ›å»ºç¬”è®°</h2>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <?php if (!empty($create_error)): ?>
                            <div class="alert alert-danger"><?php echo $create_error; ?></div>
                        <?php endif; ?>
                        <form method="POST" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="title" class="form-label">æ ‡é¢˜</label>
                                <input type="text" class="form-control" id="title" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="content" class="form-label">å†…å®¹</label>
                                <textarea class="form-control" id="content" name="content" rows="10" required></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="category_id" class="form-label">åˆ†ç±»</label>
                                <select class="form-select" id="category_id" name="category_id">
                                    <option value="">é€‰æ‹©åˆ†ç±»</option>
                                    <?php foreach ($categories as $category): ?>
                                        <option value="<?php echo $category['id']; ?>"><?php echo htmlspecialchars($category['name']); ?></option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="images" class="form-label">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¤šå¼ ï¼‰</label>
                                <input type="file" class="form-control" id="images" name="images[]" multiple>
                                <div id="imagePreviewContainer" class="mt-2"></div>
                            </div>
                            <div class="mb-3">
                                <label for="files" class="form-label">ä¸Šä¼ æ–‡ä»¶ï¼ˆå¤šä¸ªï¼‰</label>
                                <input type="file" class="form-control" id="files" name="files[]" multiple>
                            </div>
                            <button type="submit" class="btn btn-primary">åˆ›å»ºç¬”è®°</button>
                             <a href="index.php" class="btn btn-primary">è¿”å›</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('active');
        }
		

        // å›¾ç‰‡é¢„è§ˆåŠŸèƒ½
        document.getElementById('images').addEventListener('change', function(e) {
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            imagePreviewContainer.innerHTML = '';
            
            for (let i = 0; i < this.files.length; i++) {
                const file = this.files[i];
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'img-fluid image-preview';
                        img.alt = 'é¢„è§ˆå›¾ç‰‡';
                        imagePreviewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
        });
		let touchStartX = 0;
		let touchEndX = 0;
        // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹æ”¶èµ·ä¾§è¾¹æ 
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleButton = document.querySelector('.toggle-sidebar');

                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target) && window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        // ç‚¹å‡»ä¾§è¾¹æ ä¸­çš„é“¾æ¥æ—¶æ”¶èµ·ä¾§è¾¹æ 
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\create.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\delete.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨å¹¶å±äºå½“å‰ç”¨æˆ·
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ? AND user_id = ?");
$stmt->execute([$id, $_SESSION['user_id']]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨æˆ–æ‚¨æ— æƒé™æ“ä½œ");
}

// å°†ç¬”è®°ç§»åŠ¨åˆ°å›æ”¶ç«™
$stmt = $pdo->prepare("UPDATE knowledge_notes SET deleted_at = CURRENT_TIMESTAMP WHERE id = ?");
$stmt->execute([$id]);

header("Location: index.php");
exit(); 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\delete.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\edit.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨å¹¶å±äºå½“å‰ç”¨æˆ·
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ? AND user_id = ?");
$stmt->execute([$id, $_SESSION['user_id']]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨æˆ–æ‚¨æ— æƒé™è®¿é—®");
}

// è·å–çŸ¥è¯†åº“åˆ†ç±»
$categories = [];
$content = isset($_POST['content']) ? nl2br($_POST['content']) : '';
try {
    $stmt = $pdo->query("SELECT * FROM knowledge_categories ORDER BY name ASC");
    $categories = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch knowledge categories: " . $e->getMessage());
}

// å¤„ç†æ›´æ–°ç¬”è®°çš„é€»è¾‘
$update_error = '';
if ($_SERVER['REQUEST_METHOD'] == 'POST' && isset($_POST['title'])) {
    $title = $_POST['title'];
    $content = $_POST['content'];
    $category_id = isset($_POST['category_id']) && !empty($_POST['category_id']) ? (int)$_POST['category_id'] : null;

    // è·å–å·²æœ‰çš„å›¾ç‰‡å’Œæ–‡ä»¶
    $existing_images = json_decode($note['images'], true) ?? [];
    $existing_files = json_decode($note['files'], true) ?? [];

    // å¤„ç†å›¾ç‰‡åˆ é™¤
    if (isset($_POST['delete_images'])) {
        foreach ($_POST['delete_images'] as $imageIndex) {
            if (isset($existing_images[$imageIndex])) {
                // åˆ é™¤æœ¬åœ°æ–‡ä»¶
                if (file_exists($existing_images[$imageIndex])) {
                    unlink($existing_images[$imageIndex]);
                }
                // ä»æ•°ç»„ä¸­ç§»é™¤
                unset($existing_images[$imageIndex]);
            }
        }
        $existing_images = array_values($existing_images);
    }

    // å¤„ç†æ–‡ä»¶åˆ é™¤
    if (isset($_POST['delete_files'])) {
        foreach ($_POST['delete_files'] as $fileIndex) {
            if (isset($existing_files[$fileIndex])) {
                // åˆ é™¤æœ¬åœ°æ–‡ä»¶
                if (file_exists($existing_files[$fileIndex])) {
                    unlink($existing_files[$fileIndex]);
                }
                // ä»æ•°ç»„ä¸­ç§»é™¤
                unset($existing_files[$fileIndex]);
            }
        }
        $existing_files = array_values($existing_files);
    }

    // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
    $images = [];
    if (!empty($_FILES['images']['name'])) {
        $target_dir = "uploads/images/"; // ç›´æ¥å­˜å‚¨åœ¨uploads/images/
        if (!is_dir($target_dir)) {
            mkdir($target_dir, 0777, true);
        }
        foreach ($_FILES['images']['name'] as $index => $name) {
            $target_file = $target_dir . basename($name);
            $imageFileType = strtolower(pathinfo($target_file, PATHINFO_EXTENSION));
            $allowed_types = ['jpg', 'jpeg', 'png', 'gif'];
            if (in_array($imageFileType, $allowed_types)) {
                if (move_uploaded_file($_FILES["images"]["tmp_name"][$index], $target_file)) {
                    $images[] = $target_file;
                }
            }
        }
    }

    // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    $files = [];
    if (!empty($_FILES['files']['name'])) {
        $target_dir = "uploads/files/"; // ç›´æ¥å­˜å‚¨åœ¨uploads/files/
        if (!is_dir($target_dir)) {
            mkdir($target_dir, 0777, true);
        }
        foreach ($_FILES['files']['name'] as $index => $name) {
            $target_file = $target_dir . basename($name);
            if (move_uploaded_file($_FILES["files"]["tmp_name"][$index], $target_file)) {
                $files[] = $target_file;
            }
        }
    }

    // åˆå¹¶å·²æœ‰çš„å’Œæ–°ä¸Šä¼ çš„å›¾ç‰‡å’Œæ–‡ä»¶
    $images = array_merge($existing_images, $images);
    $files = array_merge($existing_files, $files);

    if (empty($title)) {
        $update_error = 'æ ‡é¢˜ä¸èƒ½ä¸ºç©º';
    } else {
        try {
            $stmt = $pdo->prepare("UPDATE knowledge_notes SET title = ?, content = ?, category_id = ?, images = ?, files = ? WHERE id = ?");
            $stmt->execute([$title, $content, $category_id, json_encode($images), json_encode($files), $id]);

            header("Location: view.php?id=$id");
            exit();
        } catch (Exception $e) {
            $update_error = 'æ›´æ–°ç¬”è®°æ—¶å‡ºé”™: ' . $e->getMessage();
        }
    }
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘ç¬”è®° - PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico" type="image/x-icon">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-200px);
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 0;
        }
        .toggle-sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            display: none;
            background-color: #343a40;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-200px);
            }
            .main-content {
                margin-left: 0;
            }
            .toggle-sidebar {
                display: block;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content.active {
                margin-left: 200px;
            }
        }
        .image-preview {
            max-width: 100%;
            max-height: 200px;
            margin-bottom: 10px;
        }
        .delete-btn {
            margin-left: 10px;
        }
        .grayed-out {
            opacity: 0.5;
            filter: grayscale(100%);
        }
    </style>
</head>
<body>
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.php">çŸ¥è¯†åº“</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../recycle.php">å›æ”¶ç«™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../favorites.php">æ”¶è—</a>
                    </li>
                    <?php if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']): ?>
                        <li class="nav-item">
                            <a class="nav-link" href="../settings.php">è®¾ç½®</a>
                        </li>
                    <?php endif; ?>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>ç¼–è¾‘ç¬”è®°</h2>
				<button class="toggle-sidebar d-lg-none" onclick="toggleSidebar()" style="left: 85%;" id="an">â˜°</button>
				<br/>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <?php if (!empty($update_error)): ?>
                            <div class="alert alert-danger"><?php echo $update_error; ?></div>
                        <?php endif; ?>
                        <form method="POST" enctype="multipart/form-data" id="editForm">
                            <div class="mb-3">
                                <label for="title" class="form-label">æ ‡é¢˜</label>
                                <input type="text" class="form-control" id="title" name="title" value="<?php echo htmlspecialchars($note['title']); ?>" required>
                            </div>
                            <div class="mb-3">
                                <label for="content" class="form-label">å†…å®¹</label>
                                <textarea class="form-control" id="content" name="content" rows="10" required><?php echo htmlspecialchars($note['content']); ?></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="category_id" class="form-label">åˆ†ç±»</label>
                                <select class="form-select" id="category_id" name="category_id">
                                    <option value="">é€‰æ‹©åˆ†ç±»</option>
                                    <?php foreach ($categories as $category): ?>
                                        <option value="<?php echo $category['id']; ?>" <?php echo $note['category_id'] == $category['id'] ? 'selected' : ''; ?>>
                                            <?php echo htmlspecialchars($category['name']); ?>
                                        </option>
                                    <?php endforeach; ?>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="images" class="form-label">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¤šå¼ ï¼‰</label>
                                <input type="file" class="form-control" id="images" name="images[]" multiple>
                                <div id="imagePreviewContainer" class="mt-2"></div>
                                <div class="mt-2" id="existingImagesContainer">
                                    <?php if (!empty($note['images'])): ?>
                                        <?php $images = json_decode($note['images'], true); ?>
                                        <?php foreach ($images as $index => $image): ?>
                                            <div class="d-flex align-items-center" id="image_<?php echo $index; ?>">
                                                <img src="<?php echo $image; ?>" alt="ç°æœ‰å›¾ç‰‡" class="img-fluid image-preview">
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-btn" onclick="markImageForDeletion(<?php echo $index; ?>)">åˆ é™¤</button>
                                                <input type="checkbox" name="delete_images[]" value="<?php echo $index; ?>" id="deleteImage_<?php echo $index; ?>" style="display: none;">
                                            </div>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="files" class="form-label">ä¸Šä¼ æ–‡ä»¶ï¼ˆå¤šä¸ªï¼‰</label>
                                <input type="file" class="form-control" id="files" name="files[]" multiple>
                                <div id="filePreviewContainer" class="mt-2"></div>
                                <div class="mt-2" id="existingFilesContainer">
                                    <?php if (!empty($note['files'])): ?>
                                        <?php $files = json_decode($note['files'], true); ?>
                                        <?php foreach ($files as $index => $file): ?>
                                            <div class="d-flex align-items-center" id="file_<?php echo $index; ?>">
                                                <a href="<?php echo $file; ?>" class="btn btn-sm btn-outline-primary" download>ä¸‹è½½æ–‡ä»¶</a>
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-btn" onclick="markFileForDeletion(<?php echo $index; ?>)">åˆ é™¤</button>
                                                <input type="checkbox" name="delete_files[]" value="<?php echo $index; ?>" id="deleteFile_<?php echo $index; ?>" style="display: none;">
                                            </div>
                                        <?php endforeach; ?>
                                    <?php endif; ?>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">ä¿å­˜æ›´æ–°</button>
							<a href="index.php" class="btn btn-primary">è¿”å›</a>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('active');
        }

        document.getElementById('images').addEventListener('change', function(e) {
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            imagePreviewContainer.innerHTML = '';
            for (let i = 0; i < this.files.length; i++) {
                const file = this.files[i];
                if (file.type.match('image.*')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'img-fluid image-preview';
                        img.alt = 'é¢„è§ˆå›¾ç‰‡';
                        imagePreviewContainer.appendChild(img);
                    }
                    reader.readAsDataURL(file);
                }
            }
        });
        function markImageForDeletion(index) {
            document.getElementById('deleteImage_' + index).checked = true;
            document.getElementById('image_' + index).classList.add('grayed-out');
        }
        function markFileForDeletion(index) {
            document.getElementById('deleteFile_' + index).checked = true;
            document.getElementById('file_' + index).classList.add('grayed-out');
        }
        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleButton = document.querySelector('.toggle-sidebar');
                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target) && window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });
        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });
        let touchStartX = 0;
        let touchEndX = 0;
        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, false);
        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);
        function handleSwipe() {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const swipeThreshold = 50;
                const difference = Math.abs(touchEndX - touchStartX);
                if (difference > swipeThreshold && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            }
        }
		
        // æŒ‰é’®çš„JS
        function isMobile() {
            return /Mobi|Android|iPhone/i.test(navigator.userAgent);
        }
        if (isMobile()) {
            document.querySelector('.toggle-sidebar').style.display = 'block';
        } else {
            document.querySelector('.toggle-sidebar').style.display = 'none';
        }
    </script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\edit.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\favories_view.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ?");
$stmt->execute([$id]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨");
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹ç¬”è®° - PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1>æŸ¥çœ‹ç¬”è®°</h1>
                <a href="../favorites.php" class="btn btn-secondary">è¿”å›æ”¶è—å¤¹</a>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><?php echo htmlspecialchars($note['title']); ?></h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><?php echo htmlspecialchars($note['content']); ?></p>
                        <?php if (!empty($note['images'])): ?>
                            <?php foreach (json_decode($note['images'], true) as $image): ?>
                                <img src="<?php echo $image; ?>" alt="ç¬”è®°å›¾ç‰‡" class="img-fluid rounded mb-2" style="max-height: 500px;">
                            <?php endforeach; ?>
                        <?php endif; ?>
                        <?php if (!empty($note['files'])): ?>
                            <div class="mt-2">
                                <?php foreach (json_decode($note['files'], true) as $file): ?>
                                    <a href="uploads/files/<?php echo basename($file); ?>" class="btn btn-sm btn-outline-primary" download>ä¸‹è½½æ–‡ä»¶</a>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">åˆ›å»ºè€…: 
                                <?php
                                $userStmt = $pdo->prepare("SELECT username FROM users WHERE id = ?");
                                $userStmt->execute([$note['user_id']]);
                                $user = $userStmt->fetch();
                                echo htmlspecialchars($user['username']);
                                ?>
                            </small>
                            <div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\favories_view.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\index.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

// è·å–çŸ¥è¯†åº“åˆ†ç±»
$categories = [];
try {
    $stmt = $pdo->query("SELECT * FROM knowledge_categories ORDER BY name ASC");
    $categories = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch knowledge categories: " . $e->getMessage());
}

// è·å–å½“å‰åˆ†ç±»ID
$categoryId = $_GET['category_id'] ?? null;

// è·å–æœç´¢å…³é”®è¯
$searchKeyword = $_GET['search'] ?? '';

// è·å–ç¬”è®°
$notes = [];
try {
    $query = "SELECT * FROM knowledge_notes";
    $params = [];
    $conditions = [];

    if ($categoryId) {
        $conditions[] = "category_id = ?";
        $params[] = $categoryId;
    }

    if (!empty($searchKeyword)) {
        $conditions[] = "title LIKE ? OR content LIKE ?";
        $params[] = "%{$searchKeyword}%";
        $params[] = "%{$searchKeyword}%";
    }

    if (!empty($conditions)) {
        $query .= " WHERE " . implode(" AND ", $conditions);
    }

    $query .= " ORDER BY created_at DESC";

    $stmt = $pdo->prepare($query);
    $stmt->execute($params);
    $notes = $stmt->fetchAll();
} catch (Exception $e) {
    error_log("Failed to fetch notes: " . $e->getMessage());
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <style>
        .sidebar {
            width: 200px;
            background-color: #343a40;
            color: white;
            height: 100vh;
            position: fixed;
            padding: 20px 0;
            transition: transform 0.3s ease;
            transform: translateX(0);
            z-index: 1000;
        }
        .sidebar.collapsed {
            transform: translateX(-200px);
        }
        .sidebar .nav-link {
            color: #dfe6e9;
            padding: 10px 20px;
            display: block;
        }
        .sidebar .nav-link:hover {
            background-color: #485460;
        }
        .sidebar .nav-link.active {
            background-color: #6c7ae0;
        }
        .main-content {
            margin-left: 200px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }
        .main-content.collapsed {
            margin-left: 0;
        }
        .toggle-sidebar {
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 1001;
            display: none;
            background-color: #343a40;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-200px);
            }
            .main-content {
                margin-left: 0;
            }
            .toggle-sidebar {
                display: block;
            }
            .sidebar.active {
                transform: translateX(0);
            }
            .main-content.active {
                margin-left: 200px;
            }
        }
        .note-card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        .note-card:hover {
            transform: translateY(-5px);
        }
        .note-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .note-card .card-body {
            padding: 20px;
        }
        .note-image {
            max-height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        .note-file {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item active">
                        <a class="nav-link" href="index.php">çŸ¥è¯†åº“</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../recycle.php">å›æ”¶ç«™</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="../favorites.php">æ”¶è—</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="openAIAndClose()">AIæ™ºèƒ½ç¬”è®°</a>
                    </li>
                    <?php if (isset($_SESSION['is_xiaoxuan']) && $_SESSION['is_xiaoxuan']): ?>
                        <li class="nav-item">
                            <a class="nav-link" href="../settings.php">è®¾ç½®</a>
                        </li>
                    <?php endif; ?>
                     <li class="nav-item">
                         <a class="nav-link" href="../logout.php">é€€å‡ºç™»å½•</a>
                     </li>
                </ul>
            </div>
            <div class="col-md-10 main-content">
                <h2>çŸ¥è¯†åº“</h2>
                <!-- æŒ‰é’®æ§ä»¶-->
                <button class="toggle-sidebar d-lg-none" onclick="toggleSidebar()" style="left: 85%;" id="an">â˜°</button>
                <br/>
                
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="mb-0">æ‰€æœ‰ç¬”è®°</h3>
                                <div class="btn-group">
                                    <a href="create.php" class="btn btn-primary">æ–°å»ºç¬”è®°</a>
                                    <a href="categories.php" class="btn btn-secondary">ç®¡ç†åˆ†ç±»</a>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <form method="GET" action="index.php" class="d-flex">
                                        <input type="text" class="form-control me-2" name="search" placeholder="è¾“å…¥å…³é”®è¯ï¼Œå…³é”®å†…å®¹ç­‰å¾…1ç§’è‡ªåŠ¨æœç´¢" value="<?php echo htmlspecialchars($searchKeyword); ?>" id="searchInput">
                                    </form>
                                </div>
                                <div class="mb-3">
                                    <label for="categoryFilter" class="form-label">é€‰æ‹©åˆ†ç±»</label>
                                    <select class="form-select" id="categoryFilter" onchange="filterNotes()">
                                        <option value="">å…¨éƒ¨åˆ†ç±»</option>
                                        <?php foreach ($categories as $category): ?>
                                            <option value="<?php echo $category['id']; ?>" <?php echo isset($categoryId) && $categoryId == $category['id'] ? 'selected' : ''; ?>>
                                                <?php echo htmlspecialchars($category['name']); ?>
                                            </option>
                                        <?php endforeach; ?>
                                    </select>
                                </div>
                                <div class="row" id="notesContainer">
                                    <?php foreach ($notes as $note): ?>
                                        <div class="col-md-12 mb-4">
                                            <div class="card note-card">
                                                <div class="card-header d-flex justify-content-between align-items-center">
                                                    <span><?php echo htmlspecialchars($note['title']); ?></span>
                                                    <small class="text-muted"><?php echo $note['created_at']; ?></small>
                                                </div>
                                                <div class="card-body">
                                                    <p class="card-text"><?php echo htmlspecialchars($note['content']); ?></p>
                                                    <?php if (!empty($note['images'])): ?>
                                                        <?php foreach (json_decode($note['images'], true) as $image): ?>
                                                            <img src="<?php echo $image; ?>" alt="ç¬”è®°å›¾ç‰‡" class="img-fluid note-image">
                                                        <?php endforeach; ?>
                                                    <?php endif; ?>
                                                    <?php if (!empty($note['files'])): ?>
                                                        <div class="mt-2">
                                                            <?php foreach (json_decode($note['files'], true) as $file): ?>
                                                                <a href="<?php echo htmlspecialchars($file); ?>" class="btn btn-sm btn-outline-primary note-file" download>ä¸‹è½½æ–‡ä»¶</a>
                                                            <?php endforeach; ?>
                                                        </div>
                                                    <?php endif; ?>
                                                    <div class="d-flex justify-content-between mt-2">
                                                        <small class="text-muted">åˆ›å»ºè€…: 
                                                            <?php
                                                            if (isset($note['user_id'])) {
                                                                $userStmt = $pdo->prepare("SELECT username FROM users WHERE id = ?");
                                                                $userStmt->execute([$note['user_id']]);
                                                                $user = $userStmt->fetch();
                                                                echo htmlspecialchars($user['username']);
                                                            } else {
                                                                echo "æœªçŸ¥";
                                                            }
                                                            ?>
                                                        </small>
                                                        <div>
                                                            <?php if (isset($_SESSION['user_id']) && $_SESSION['user_id'] == $note['user_id']): ?>
                                                                <a href="edit.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                                                                <a href="delete.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')">ç§»å…¥å›æ”¶ç«™</a>
                                                            <?php endif; ?>
                                                            <a href="view.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-secondary">æµè§ˆ</a>
                                                            <!-- æ·»åŠ æ”¶è—æŒ‰é’® -->
                                                            <form method="POST" action="../favorites.php" style="display: inline;">
                                                                <input type="hidden" name="note_id" value="<?php echo $note['id']; ?>">
                                                                <?php
                                                                // æ£€æŸ¥å½“å‰ç¬”è®°æ˜¯å¦å·²è¢«æ”¶è—
                                                                $stmt = $pdo->prepare("SELECT * FROM favorites WHERE user_id = ? AND note_id = ?");
                                                                $stmt->execute([$_SESSION['user_id'], $note['id']]);
                                                                $isFavorite = $stmt->fetch();
                                                                ?>
                                                                <input type="hidden" name="action" value="<?php echo $isFavorite ? 'remove_favorite' : 'add_favorite'; ?>">
                                                                <button type="submit" class="btn btn-sm btn-outline-danger">
                                                                    <?php echo $isFavorite ? 'å–æ¶ˆæ”¶è—' : 'æ”¶è—'; ?>
                                                                </button>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
    <script>
        // AIé“¾æ¥ç‚¹å‡»å¤„ç†å‡½æ•°
        function openAIAndClose() {
            // åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€AIç•Œé¢
            window.open('../desp/index.html', '_blank');
            
            // å°è¯•å…³é—­å½“å‰çª—å£
            window.opener = null;
            window.open('', '_self');
            window.close();
            
            return false; // é˜»æ­¢é»˜è®¤é“¾æ¥è¡Œä¸º
        }

        function isMobile() {
            return /Mobi|Android|iPhone/i.test(navigator.userAgent);
        }
        isMobile();
        if (isMobile()) {
            document.querySelector('#an').style.display = 'block';
        } else {
            document.querySelector('#an').style.display = 'none';
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            sidebar.classList.toggle('active');
            mainContent.classList.toggle('active');
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.addEventListener('click', function(event) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const toggleButton = document.querySelector('.toggle-sidebar');

                if (!sidebar.contains(event.target) && !toggleButton.contains(event.target) && window.innerWidth <= 768) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        document.querySelectorAll('.sidebar .nav-link').forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 768) {
                    const sidebar = document.querySelector('.sidebar');
                    const mainContent = document.querySelector('.main-content');
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            });
        });

        let touchStartX = 0;
        let touchEndX = 0;

        document.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
        }, false);

        document.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, false);

        function handleSwipe() {
            if (window.innerWidth <= 768) {
                const sidebar = document.querySelector('.sidebar');
                const mainContent = document.querySelector('.main-content');
                const swipeThreshold = 50;
                const difference = Math.abs(touchEndX - touchStartX);

                if (difference > swipeThreshold && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mainContent.classList.remove('active');
                }
            }
        }

        function filterNotes() {
            const categoryId = document.getElementById('categoryFilter').value;
            const searchKeyword = document.getElementById('searchInput')?.value ?? '';
            window.location.href = 'index.php?category_id=' + categoryId + '&search=' + encodeURIComponent(searchKeyword);
        }

        let searchTimeout;
        document.getElementById('searchInput').addEventListener('input', function() {
            const searchKeyword = this.value;
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const categoryId = document.getElementById('categoryFilter').value;
                window.location.href = 'index.php?category_id=' + categoryId + '&search=' + encodeURIComponent(searchKeyword);
            }, 400);
        });
    </script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\index.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\recycle_view.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ?");
$stmt->execute([$id]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨");
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹ç¬”è®° - PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1>æŸ¥çœ‹ç¬”è®°</h1>
                <a href="../recycle.php" class="btn btn-secondary">è¿”å›å›æ”¶ç«™</a>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><?php echo htmlspecialchars($note['title']); ?></h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><?php echo htmlspecialchars($note['content']); ?></p>
                        <?php if (!empty($note['images'])): ?>
                            <?php foreach (json_decode($note['images'], true) as $image): ?>
                                <img src="<?php echo $image; ?>" alt="ç¬”è®°å›¾ç‰‡" class="img-fluid rounded mb-2" style="max-height: 500px;">
                            <?php endforeach; ?>
                        <?php endif; ?>
                        <?php if (!empty($note['files'])): ?>
                            <div class="mt-2">
                                <?php foreach (json_decode($note['files'], true) as $file): ?>
                                    <a href="/uploads/files/<?php echo basename($file); ?>" class="btn btn-sm btn-outline-primary" download>ä¸‹è½½æ–‡ä»¶</a>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">åˆ›å»ºè€…: 
                                <?php
                                $userStmt = $pdo->prepare("SELECT username FROM users WHERE id = ?");
                                $userStmt->execute([$note['user_id']]);
                                $user = $userStmt->fetch();
                                echo htmlspecialchars($user['username']);
                                ?>
                            </small>
                            <div>
                                <?php if (isset($_SESSION['user_id']) && $_SESSION['user_id'] == $note['user_id']): ?>
                                    <a href="edit.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                                    <a href="delete.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')">åˆ é™¤</a>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\recycle_view.php ======= 
 
 
======= ¿ªÊ¼£ºD:\phpstudy_pro\note_cloud\knowledge\view.php ======= 
 
<?php
session_start();
include('../includes/config.php');

// æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
if (!isset($_SESSION['user_id'])) {
    header("Location: ../login.php");
    exit();
}

$id = $_GET['id'] ?? null;

// æ£€æŸ¥ç¬”è®°æ˜¯å¦å­˜åœ¨
$stmt = $pdo->prepare("SELECT * FROM knowledge_notes WHERE id = ?");
$stmt->execute([$id]);
$note = $stmt->fetch();

if (!$note) {
    die("ç¬”è®°ä¸å­˜åœ¨");
}
?>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŸ¥çœ‹ç¬”è®° - PZIOTç¬”è®°ç½‘</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
	<link rel="icon" href="http://10.92.169.234:8800/admin/down.php/a6c2ff793b37e00796a7f0d1624131ad.ico)" type="image/x-icon">
</head>
<body>
    <div class="container mt-5">
        <div class="row">
            <div class="col-md-12">
                <h1>æŸ¥çœ‹ç¬”è®°</h1>
                <a href="index.php" class="btn btn-secondary">è¿”å›çŸ¥è¯†åº“</a>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0"><?php echo htmlspecialchars($note['title']); ?></h3>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><?php echo htmlspecialchars($note['content']); ?></p>
                        <?php if (!empty($note['images'])): ?>
                            <?php foreach (json_decode($note['images'], true) as $image): ?>
                                <img src="<?php echo $image; ?>" alt="ç¬”è®°å›¾ç‰‡" class="img-fluid rounded mb-2" style="max-height: 500px;">
                            <?php endforeach; ?>
                        <?php endif; ?>
                        <?php if (!empty($note['files'])): ?>
                            <div class="mt-2">
                                <?php foreach (json_decode($note['files'], true) as $file): ?>
                                    <a href="/uploads/files/<?php echo basename($file); ?>" class="btn btn-sm btn-outline-primary" download>ä¸‹è½½æ–‡ä»¶</a>
                                <?php endforeach; ?>
                            </div>
                        <?php endif; ?>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">åˆ›å»ºè€…: 
                                <?php
                                $userStmt = $pdo->prepare("SELECT username FROM users WHERE id = ?");
                                $userStmt->execute([$note['user_id']]);
                                $user = $userStmt->fetch();
                                echo htmlspecialchars($user['username']);
                                ?>
                            </small>
                            <div>
                                <?php if (isset($_SESSION['user_id']) && $_SESSION['user_id'] == $note['user_id']): ?>
                                    <a href="edit.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-primary">ç¼–è¾‘</a>
                                    <a href="delete.php?id=<?php echo $note['id']; ?>" class="btn btn-sm btn-outline-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤ç¬”è®°å—ï¼Ÿ')">åˆ é™¤</a>
                                <?php endif; ?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="../js/bootstrap.bundle.min.js"></script>
</body>
</html> 
======= ½áÊø£ºD:\phpstudy_pro\note_cloud\knowledge\view.php ======= 
 
